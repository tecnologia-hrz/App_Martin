<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XSHOP - Tienda</title>
    <link rel="stylesheet" href="chat-cliente.css">
    <link rel="stylesheet" href="chat-ia.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
        }

        .contenedor-principal {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }

        /* Header */
        .header {
            background: #f8f9fa;
            color: #333333;
            padding: 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .cerrar-sesion {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.1);
            border: none;
            color: #333333;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .cerrar-sesion:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        .titulo-principal {
            font-size: 28px;
            font-weight: bold;
            margin: 0;
        }

        /* Botones de navegación */
        .contenedor-navegacion {
            background: #ffffff;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
        }

        .botones-navegacion {
            display: flex;
            gap: 10px;
            background: #e9ecef;
            padding: 5px;
            border-radius: 25px;
        }

        .boton-nav {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666666;
        }

        .boton-nav.activo {
            background: #ffffff;
            color: #333333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .boton-nav:hover {
            background: #f8f9fa;
            color: #333333;
        }

        /* Secciones de contenido */
        .seccion-contenido {
            min-height: 400px;
        }

        /* Barra de búsqueda */
        .contenedor-busqueda {
            padding: 20px;
            position: relative;
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
        }

        .barra-busqueda {
            width: 100%;
            padding: 15px 20px;
            padding-left: 50px;
            border: 2px solid #e0e0e0;
            background: #ffffff;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .barra-busqueda:focus {
            outline: none;
            border-color: #000000;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .icono-buscar {
            position: absolute;
            left: 35px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 18px;
            pointer-events: none;
        }



        /* Lista de productos */
        .contenedor-productos {
            padding: 0 20px;
            min-height: 400px;
        }

        .producto-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            border: 1px solid #f0f0f0;
        }

        .producto-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            border-color: #e0e0e0;
        }

        .producto-contenido {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .producto-imagen {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: #f0f0f0;
            margin-right: 15px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .producto-info {
            flex: 1;
        }

        .producto-nombre {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            margin-bottom: 8px;
        }

        .producto-precio {
            font-size: 18px;
            font-weight: bold;
            color: #000000;
        }

        /* Botones de acción en productos */
        .producto-acciones {
            display: flex;
            gap: 10px;
        }

        .boton-accion {
            flex: 1;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .boton-ver {
            background: #007bff;
            color: white;
        }

        .boton-ver:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .boton-ver:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(0, 123, 255, 0.2);
        }

        .boton-añadir {
            background: #28a745;
            color: white;
        }

        .boton-añadir:hover {
            background: #1e7e34;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .boton-añadir:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(40, 167, 69, 0.2);
        }

        .boton-sin-stock {
            background: #6c757d;
            color: white;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .boton-accion:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .boton-añadir:focus {
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
        }

        /* Modal del producto */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-contenido {
            background: #f0f0f0;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            border-radius: 20px;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            background: #f0f0f0;
            color: #333333;
            padding: 20px;
            text-align: left;
            position: relative;
            border-radius: 20px 20px 0 0;
        }

        .boton-volver {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #666666;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .boton-volver:hover {
            color: #333333;
        }

        .modal-titulo {
            font-size: 20px;
            font-weight: 600;
            color: #333333;
            margin: 0;
        }

        .modal-body {
            padding: 20px;
            background: #f0f0f0;
        }

        .producto-imagen-grande {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .producto-precio-badge {
            display: inline-block;
            background: #d4edda;
            color: #155724;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .producto-info-item {
            margin-bottom: 15px;
        }

        .producto-info-label {
            font-size: 14px;
            color: #666666;
            margin-bottom: 5px;
        }

        .producto-info-valor {
            font-size: 16px;
            color: #333333;
            font-weight: 500;
        }

        .descripcion-section {
            margin-bottom: 20px;
        }

        .descripcion-title {
            font-size: 18px;
            font-weight: 600;
            color: #333333;
            margin-bottom: 10px;
        }

        .descripcion-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            color: #666666;
            background: #ffffff;
            resize: none;
            min-height: 40px;
        }

        /* Estilos para opciones de envío e IGV */
        .opciones-compra {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }

        .opciones-titulo {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .opcion-envio {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .opcion-envio:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }

        .opcion-envio.seleccionada {
            border-color: #007bff;
            background: #e7f3ff;
        }

        .opcion-envio-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .opcion-envio-radio {
            width: 18px;
            height: 18px;
            border: 2px solid #dee2e6;
            border-radius: 50%;
            position: relative;
            transition: all 0.3s;
        }

        .opcion-envio.seleccionada .opcion-envio-radio {
            border-color: #007bff;
        }

        .opcion-envio.seleccionada .opcion-envio-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: #007bff;
            border-radius: 50%;
        }

        .opcion-envio-texto {
            flex: 1;
        }

        .opcion-envio-nombre {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .opcion-envio-descripcion {
            font-size: 12px;
            color: #666;
        }

        .opcion-envio-precio {
            font-weight: bold;
            color: #28a745;
        }

        .resumen-compra {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }

        .resumen-titulo {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .resumen-linea {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #666;
        }

        .resumen-linea.total {
            border-top: 1px solid #e9ecef;
            padding-top: 10px;
            margin-top: 10px;
            font-weight: bold;
            color: #333;
            font-size: 18px;
        }

        .precio-original {
            color: #666;
        }

        .precio-envio {
            color: #007bff;
        }

        .precio-igv {
            color: #ffc107;
        }

        .precio-total {
            color: #28a745;
        }

        .modal-botones {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-agregar {
            background: #007bff;
            color: white;
        }

        .btn-agregar:hover {
            background: #0056b3;
        }

        .btn-comprar {
            background: #28a745;
            color: white;
        }

        .btn-comprar:hover {
            background: #1e7e34;
        }

        /* Carrito flotante */
        .carrito-flotante {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #000000;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            z-index: 999;
        }

        .carrito-flotante:hover {
            transform: scale(1.1);
        }

        .carrito-contador {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* Estados */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #000000;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .mensaje-vacio {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .mensaje-vacio-icono {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.mostrar {
            transform: translateX(0);
        }

        .toast.error {
            background: #dc3545;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .modal-contenido {
                width: 95%;
            }
        }

        /* Modal del carrito */
        .modal-carrito {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .carrito-contenido {
            background: #f0f7ff;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            border-radius: 20px;
            overflow-y: auto;
            position: relative;
        }

        .carrito-header {
            background: #f0f7ff;
            color: #333333;
            padding: 20px;
            text-align: left;
            position: relative;
            border-radius: 20px 20px 0 0;
            border-bottom: 1px solid #d1e3ff;
        }

        .carrito-header .boton-volver {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #666666;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .carrito-header .boton-volver:hover {
            color: #333333;
        }

        .carrito-body {
            padding: 20px;
            background: #f0f7ff;
        }

        .carrito-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            background: white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .carrito-item-imagen {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 15px;
        }

        .carrito-item-info {
            flex: 1;
        }

        .carrito-item-nombre {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333333;
            font-size: 14px;
        }

        .carrito-item-precio {
            color: #007bff;
            font-weight: bold;
            font-size: 16px;
        }

        /* Estilos para el carrito mejorado */
        .carrito-item-detalles {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin: 8px 0;
            font-size: 12px;
            color: #666;
        }

        .carrito-item-talla,
        .carrito-item-color,
        .carrito-item-envio {
            background: #f8f9fa;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
            width: fit-content;
        }

        .carrito-item-envio {
            background: #e3f2fd;
            color: #1976d2;
        }

        .carrito-item-total {
            font-weight: 600;
            color: #007bff;
            margin-top: 8px;
            font-size: 14px;
        }

        .carrito-resumen {
            border-top: 2px solid #eee;
            padding-top: 16px;
            margin-top: 16px;
        }

        .carrito-resumen-linea {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 14px;
            color: #666;
        }

        .carrito-resumen-linea:last-child {
            border-top: 1px solid #eee;
            padding-top: 12px;
            margin-top: 8px;
        }

        .carrito-item-cantidad {
            display: flex;
            align-items: center;
            margin-top: 10px;
            background: #f8f9fa;
            border-radius: 20px;
            padding: 5px;
            width: fit-content;
        }

        .cantidad-btn {
            background: white;
            border: 1px solid #dee2e6;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            color: #333;
            transition: all 0.2s;
        }

        .cantidad-btn:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .cantidad-numero {
            margin: 0 15px;
            font-weight: 600;
            color: #333;
        }

        .carrito-total {
            padding: 20px;
            border-top: 1px solid #d1e3ff;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            color: #333333;
            background: white;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .carrito-botones {
            padding: 20px;
            display: flex;
            gap: 10px;
        }

        .carrito-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-vaciar {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #dee2e6;
        }

        .btn-vaciar:hover {
            background: #e9ecef;
        }

        .btn-comprar {
            background: #007bff;
            color: white;
        }

        .btn-comprar:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .carrito-vacio {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            background: white;
            border-radius: 12px;
            margin: 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .carrito-vacio svg {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
            color: #007bff;
            opacity: 0.5;
        }

        .carrito-vacio p {
            font-size: 16px;
            color: #333;
            margin-top: 10px;
        }

        /* Estilos para información de envío en historial */
        .pedido-envio-info {
            margin-top: 5px;
            padding-left: 15px;
        }

        .pedido-envio-info small {
            display: block;
            color: #666;
            font-size: 12px;
            margin: 2px 0;
        }

        /* Modal de selección de asesor */
        .modal-asesor {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .asesor-contenido {
            background: #f0f0f0;
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            overflow: hidden;
        }

        .asesor-header {
            background: #f0f0f0;
            color: #333333;
            padding: 20px;
            text-align: left;
            position: relative;
            border-radius: 20px 20px 0 0;
        }

        .asesor-header .boton-volver {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #666666;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .asesor-header .boton-volver:hover {
            color: #333333;
        }

        .asesor-body {
            padding: 20px;
            background: #f0f0f0;
        }

        .lista-asesores {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }

        .asesor-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #eee;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .asesor-item:hover {
            border-color: #000000;
            background: #f8f9fa;
        }

        .asesor-item.seleccionado {
            border-color: #000000;
            background: #f8f9fa;
        }

        .asesor-foto {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }

        .asesor-info {
            flex: 1;
        }

        .asesor-nombre {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .asesor-estado {
            font-size: 14px;
            color: #28a745;
        }

        /* Botón de pedidos */
        .pedidos-flotante {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: #000000;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            z-index: 999;
        }

        .pedidos-flotante:hover {
            transform: scale(1.1);
        }

        /* Botón de chat flotante */
        .chat-flotante-cliente {
            position: fixed;
            bottom: 160px;
            right: 20px;
            background: #000000;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            z-index: 999;
            border: none;
        }

        .chat-flotante-cliente:hover {
            transform: scale(1.1);
        }

        .chat-flotante-cliente.tiene-mensajes {
            animation: pulsoChat 2s infinite;
        }

        @keyframes pulsoChat {
            0% {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            50% {
                box-shadow: 0 4px 20px rgba(220, 53, 69, 0.6);
            }

            100% {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }
        }

        /* Modal de pedidos */
        .modal-pedidos {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .pedidos-contenido {
            background: #f0f0f0;
            width: 95%;
            max-width: 500px;
            max-height: 90vh;
            border-radius: 20px;
            overflow: hidden;
        }

        .pedidos-header {
            background: #f0f0f0;
            color: #333333;
            padding: 20px;
            text-align: left;
            position: relative;
            border-radius: 20px 20px 0 0;
        }

        .pedidos-header .boton-volver {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #666666;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pedidos-header .boton-volver:hover {
            color: #333333;
        }

        .pedidos-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(90vh - 70px);
            background: #f0f0f0;
        }

        .pedido-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }

        .pedido-encabezado {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .pedido-numero {
            font-weight: bold;
            color: #000000;
        }

        .pedido-fecha {
            color: #666;
            font-size: 0.9em;
        }

        .pedido-estado {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .estado-pendiente {
            background: #fff3cd;
            color: #856404;
        }

        .estado-finalizado {
            background: #d4edda;
            color: #155724;
        }

        .estado-recoger {
            background: #cce5ff;
            color: #004085;
        }

        .pedido-productos {
            margin-top: 10px;
        }

        .pedido-producto-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            color: #666;
        }

        .pedido-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
            text-align: right;
            font-weight: bold;
        }

        .sin-pedidos {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        /* Sección de chats */
        .contenedor-chats {
            padding: 20px;
        }

        .info-chats {
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .info-chats h3 {
            color: #333333;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .info-chats p {
            color: #666666;
            font-size: 14px;
            margin: 0;
        }

        .lista-chats {
            display: grid;
            gap: 15px;
        }

        .chat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .chat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border-color: #007bff;
        }

        /* Estilos especiales para el chat IA */
        .chat-ia-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid transparent;
        }

        .chat-ia-card:hover {
            border-color: #ffffff;
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
        }

        .chat-ia-card .chat-nombre {
            color: white;
        }

        .chat-ia-card .chat-ultimo-mensaje {
            color: rgba(255, 255, 255, 0.9);
        }

        .chat-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }

        .chat-avatar-ia {
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .chat-info {
            flex: 1;
        }

        .chat-nombre {
            font-weight: 600;
            font-size: 16px;
            color: #333333;
            margin-bottom: 5px;
        }

        .chat-estado {
            color: #28a745;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chat-estado-ia {
            color: rgba(255, 255, 255, 0.9);
        }

        .punto-verde {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            display: inline-block;
        }

        .punto-ia {
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            display: inline-block;
            animation: pulsoIA 2s infinite;
        }

        @keyframes pulsoIA {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .chat-ultimo-mensaje {
            color: #666666;
            font-size: 14px;
            margin-bottom: 15px;
            font-style: italic;
            line-height: 1.4;
        }

        .chat-acciones {
            display: flex;
            gap: 10px;
        }

        .btn-chat {
            flex: 1;
            padding: 10px 20px;
            background: #25d366;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-chat:hover {
            background: #128c7e;
            transform: translateY(-1px);
        }

        .btn-chat-ia {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-chat-ia:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* Separador entre IA y asesores humanos */
        .separador-chats {
            text-align: center;
            margin: 30px 0 20px 0;
            position: relative;
        }

        .separador-chats::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e0e0e0;
        }

        .separador-chats span {
            background: #f5f5f7;
            padding: 0 15px;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .chip-color,
        .chip-talla {
            border: 2px solid #fff;
            padding: 7px 16px;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chip-color {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            outline: none;
            vertical-align: middle;
            box-shadow: 0 1px 4px #0001;
        }

        .chip-talla {
            display: inline-block;
            margin: 0 6px 6px 0;
        }

        .metodo-pago-btn {
            padding: 18px 24px;
            border-radius: 12px;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .btn-categoria {
            padding: 10px 18px;
            border: none;
            border-radius: 20px;
            background: #000000;
            color: #ffffff;

            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            white-space: nowrap;
        }

        .btn-categoria.activa,
        .btn-categoria:hover {
            background: #007bff;
            color: #fff;
        }

        .barra-categorias::-webkit-scrollbar {
            height: 6px;
        }

        .barra-categorias::-webkit-scrollbar-thumb {
            background: #eee;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <div class="contenedor-principal">
        <!-- Header -->
        <div class="header">
            <button class="cerrar-sesion" onclick="cerrarSesion()">
                Cerrar Sesion
            </button>
            <h1 class="titulo-principal">XSHOP</h1>
        </div>

        <!-- Barra de búsqueda -->
        <div class="contenedor-busqueda">
            <div style="position: relative;">
                <span class="icono-buscar">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M21 21L16.514 16.506M19 10.5C19 15.194 15.194 19 10.5 19S2 15.194 2 10.5 5.806 2 10.5 2 19 5.806 19 10.5Z"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </span>
                <input type="text" class="barra-busqueda" placeholder="Buscar" id="inputBusqueda"
                    onkeyup="filtrarProductos()">
            </div>
        </div>

        <!-- Botones de navegación -->
        <div class="contenedor-navegacion">
            <div class="botones-navegacion">
                <button class="boton-nav" onclick="mostrarSeccion('chats')">CHATS</button>
                <button class="boton-nav activo" onclick="mostrarSeccion('productos')">PRODUCTOS</button>
                <button class="boton-nav" onclick="abrirProductosPrueba()">PRUEBA API</button>
            </div>
        </div>

        <!-- Barra de categorías solo para productos -->
        <div class="barra-categorias" id="barraCategorias"
            style="display:flex;gap:10px;overflow-x:auto;padding:10px 20px 0 20px;margin-bottom:10px;">
            <button class="btn-categoria" onclick="filtrarPorCategoria('')">Todos</button>
            <button class="btn-categoria" onclick="filtrarPorCategoria('pantalones')">Pantalones</button>
            <button class="btn-categoria" onclick="filtrarPorCategoria('camisas')">Camisas</button>
            <button class="btn-categoria" onclick="filtrarPorCategoria('polos')">Polos</button>
            <button class="btn-categoria" onclick="filtrarPorCategoria('jeans')">Jeans</button>
            <button class="btn-categoria" onclick="filtrarPorCategoria('chompas')">Chompas</button>
            <button class="btn-categoria" onclick="filtrarPorCategoria('casacas')">Casacas</button>
            <button class="btn-categoria" onclick="filtrarPorCategoria('zapatos')">Zapatos</button>
            <button class="btn-categoria" onclick="filtrarPorCategoria('zapatillas')">Zapatillas</button>
            <button class="btn-categoria" onclick="filtrarPorCategoria('accesorios')">Accesorios</button>
        </div>

        <!-- Sección de productos -->
        <div id="seccionProductos" class="seccion-contenido">



            <!-- Lista de productos -->
            <div class="contenedor-productos" id="contenedorProductos">
                <div class="loading">
                    <div class="spinner"></div>
                    Cargando productos...
                </div>
            </div>
        </div>

        <!-- Sección de chats -->
        <div id="seccionChats" class="seccion-contenido" style="display: none;">
            <div class="contenedor-chats">
                <div class="info-chats">
                    <h3>Chats Disponibles</h3>
                    <p>Elige entre asesor virtual IA o asesores humanos</p>
                </div>

                <!-- Chat con IA - Primera opción -->
                <div class="chat-card chat-ia-card" onclick="chatIA.abrirChatIA()">
                    <div class="chat-header">
                        <div class="chat-avatar chat-avatar-ia">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M8 21L9.5 16.5L13 18L9.5 19.5L8 21Z" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M16 5L17 8L20 9L17 10L16 13L15 10L12 9L15 8L16 5Z" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                        <div class="chat-info">
                            <div class="chat-nombre">Asesor Virtual IA</div>
                            <div class="chat-estado chat-estado-ia">
                                <span class="punto-ia"></span>
                                Siempre disponible
                            </div>
                        </div>
                    </div>
                    <div class="chat-ultimo-mensaje">
                        ¡Hola! Soy tu asesor virtual. Pregúntame sobre productos, tallas, envíos y más...
                    </div>
                    <div class="chat-acciones">
                        <button class="btn-chat btn-chat-ia">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            Iniciar Chat IA
                        </button>
                    </div>
                </div>

                <!-- Separador -->
                <div class="separador-chats">
                    <span>Asesores Humanos</span>
                </div>

                <div class="lista-chats" id="listaChats">
                    <!-- Los chats con asesores humanos se cargarán dinámicamente -->
                </div>
            </div>
        </div>

        <!-- Carrito flotante -->
        <div class="carrito-flotante" onclick="abrirCarrito()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M3 3H5L5.4 5M7 13H17L21 5H5.4M7 13L5.4 5M7 13L4.7 15.3C4.3 15.7 4.6 16.5 5.1 16.5H17M17 13V17C17 18.1 16.1 19 15 19H9C7.9 19 7 18.1 7 17V13H17Z"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <div class="carrito-contador" id="carritoContador" style="display: none;">0</div>
        </div>

        <!-- Modal para ver producto -->
        <div class="modal" id="modalProducto">
            <div class="modal-contenido">
                <div class="modal-header">
                    <h2 class="modal-titulo">Producto</h2>
                    <button class="boton-volver" onclick="cerrarModal()">×</button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Contenido dinámico -->
                </div>
            </div>
        </div>

        <!-- Modal del carrito -->
        <div class="modal-carrito" id="modalCarrito">
            <div class="carrito-contenido">
                <div class="carrito-header">
                    <h2>Mi Carrito</h2>
                    <button class="boton-volver" onclick="cerrarCarrito()">×</button>
                </div>
                <div class="carrito-body" id="carritoBody">
                    <!-- El contenido del carrito se generará dinámicamente -->
                </div>
            </div>
        </div>

        <!-- Modal de selección de asesor -->
        <div class="modal-asesor" id="modalAsesor">
            <div class="asesor-contenido">
                <div class="asesor-header">
                    <h2>Selecciona un Asesor</h2>
                    <button class="boton-volver" onclick="cerrarModalAsesor()">×</button>
                </div>
                <div class="asesor-body">
                    <div class="lista-asesores" id="listaAsesores">
                        <!-- Los asesores se cargarán dinámicamente -->
                    </div>
                </div>
            </div>
        </div>



        <!-- Modal de pedidos -->
        <div class="modal-pedidos" id="modalPedidos">
            <div class="pedidos-contenido">
                <div class="pedidos-header">
                    <h2>Mis Pedidos</h2>
                    <button class="boton-volver" onclick="cerrarModalPedidos()">×</button>
                </div>
                <div class="pedidos-body" id="pedidosBody">
                    <!-- El contenido se cargará dinámicamente -->
                </div>
            </div>
        </div>

        <!-- Botón de chat flotante -->
        <button class="chat-flotante-cliente" onclick="abrirChatFlotante()" title="Chat con asesor">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </button>

        <!-- 1. Botón de historial en la interfaz (después del carrito flotante) -->
        <div class="pedidos-flotante" onclick="verHistorial()" title="Ver historial de pedidos">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 8V12L14.5 14.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
            </svg>
        </div>

        <!-- 2. Modal de método de pago (al final del body) -->
        <div class="modal" id="modalPago">
            <div class="modal-contenido">
                <div class="modal-header">
                    <h2 class="modal-titulo">Método de Pago</h2>
                    <button class="boton-volver" onclick="cerrarModalPago()">×</button>
                </div>
                <div class="modal-body" id="modalPagoBody">
                    <!-- Contenido dinámico -->
                </div>
            </div>
        </div>

        <script type="module">
            import { obtenerUsuarioActual, cerrarSesion as cerrarSesionFirebase } from './firebase-config.js';
            import { getFirestore, collection, getDocs, addDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
            import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
            import './chat-cliente.js';

            // Configuración de Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyAkGt9mcgneJCofgY5fwSyHWcKJVNUmUoU",
                authDomain: "app-ventas-martin.firebaseapp.com",
                projectId: "app-ventas-martin",
                storageBucket: "app-ventas-martin.firebasestorage.app",
                messagingSenderId: "309262005814",
                appId: "1:309262005814:web:d1d3fc9df63f55e31cca97",
                measurementId: "G-2ZZT0VSKT7"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            let chatCliente = null;

            // Variables globales
            let productos = [];
            let carrito = JSON.parse(localStorage.getItem('carrito')) || [];

            // Variables para pedidos
            let asesoresDisponibles = [];

            // Verificar acceso de cliente
            function verificarAccesoCliente() {
                const usuario = obtenerUsuarioActual();
                if (!usuario) {
                    mostrarToast('Debes iniciar sesión para acceder', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return false;
                }
                return true;
            }

            // Función para mostrar toast
            function mostrarToast(mensaje, tipo = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${tipo === 'error' ? 'error' : ''}`;
                toast.textContent = mensaje;
                document.body.appendChild(toast);

                setTimeout(() => toast.classList.add('mostrar'), 100);
                setTimeout(() => {
                    toast.classList.remove('mostrar');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            // Cargar productos de Firestore
            async function cargarProductos() {
                try {
                    const productosRef = collection(db, "productos");
                    const snapshot = await getDocs(productosRef);

                    productos = [];
                    snapshot.forEach((doc) => {
                        productos.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });

                    mostrarProductos();
                    actualizarContadorCarrito();
                } catch (error) {
                    console.error('Error cargando productos:', error);
                    document.getElementById('contenedorProductos').innerHTML = `
                    <div class="mensaje-vacio">
                        <div class="mensaje-vacio-icono">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 9V13M12 17H12.01M21 12C21 16.9706 16.9706 21 12 21S3 16.9706 3 12 7.02944 3 12 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <p>Error al cargar productos</p>
                    </div>
                `;
                }
            }

            // Mostrar lista de productos
            function mostrarProductos() {
                const contenedor = document.getElementById('contenedorProductos');

                let productosFiltrados = productos;

                // Filtrar por búsqueda
                const termino = document.getElementById('inputBusqueda').value.toLowerCase();
                if (termino) {
                    productosFiltrados = productosFiltrados.filter(producto =>
                        producto.nombre.toLowerCase().includes(termino) ||
                        producto.categoria.toLowerCase().includes(termino) ||
                        (producto.color && producto.color.toLowerCase().includes(termino))
                    );
                }

                // Filtrar por categoría seleccionada
                if (categoriaSeleccionada) {
                    productosFiltrados = productosFiltrados.filter(producto => producto.categoria && producto.categoria.toLowerCase() === categoriaSeleccionada);
                }

                if (productosFiltrados.length === 0) {
                    contenedor.innerHTML = `
                    <div class="mensaje-vacio">
                        <div class="mensaje-vacio-icono">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 7L4 7L6 21L18 21L20 7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <p>No se encontraron productos</p>
                    </div>
                `;
                    return;
                }

                let html = '';
                productosFiltrados.forEach(producto => {
                    const enStock = producto.stock > 0;
                    // Procesar tallas y colores
                    const tallas = producto.tallas ? producto.tallas.split(',').map(t => t.trim()) : [];
                    const color = producto.color || '';

                    html += `
                    <div class="producto-item">
                        <div class="producto-contenido">
                            <img src="${producto.imagen || 'https://via.placeholder.com/60'}" 
                                 alt="${producto.nombre}" 
                                 class="producto-imagen" 
                                 onerror="this.src='https://via.placeholder.com/60'">
                            <div class="producto-info">
                                <div class="producto-nombre">${producto.nombre}</div>
                                <div class="producto-precio">S/${producto.precio}</div>
                                <div style="margin-top: 8px;">
                                    ${color ? `<span style='display:inline-block;background:#eee;border-radius:8px;padding:2px 10px;font-size:12px;margin-right:6px;'>Color: ${color}</span>` : ''}
                                    ${tallas.length > 0 ? `<span style='display:inline-block;background:#eee;border-radius:8px;padding:2px 10px;font-size:12px;'>Tallas: ${tallas.join(', ')}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="producto-acciones">
                            <button class="boton-accion boton-ver" onclick="abrirProducto('${producto.id}')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Ver
                            </button>
                            ${enStock ? `
                            <button class="boton-accion boton-añadir" onclick="abrirProducto('${producto.id}', true)">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M6 2L3 6V20C3 21.1046 3.89543 22 5 22H19C20.1046 22 21 21.1046 21 20V6L18 2H6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 10C16 13.3137 13.3137 16 10 16C6.68629 16 4 13.3137 4 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Añadir
                            </button>` : `
                            <button class="boton-accion boton-sin-stock" disabled>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                    <path d="M15 9L9 15M9 9L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                Sin Stock
                            </button>`}
                        </div>
                    </div>
                `;
                });

                contenedor.innerHTML = html;
            }

            // Filtrar productos por búsqueda
            window.filtrarProductos = function () {
                mostrarProductos();
            };



            // Reemplazo de window.abrirProducto para permitir selección de talla y color
            window.abrirProducto = function (id, modoAgregarDirecto) {
                const producto = productos.find(p => p.id === id);
                if (!producto) return;
                const enStock = producto.stock > 0;
                const tallas = producto.tallas ? producto.tallas.split(',').map(t => t.trim()) : [];
                // Permitir varios colores en el futuro (soporte para string separado por coma)
                const colores = producto.color ? producto.color.split(',').map(c => c.trim()) : [];
                let tallaSeleccionada = '';
                let colorSeleccionado = colores.length > 0 ? colores[0] : '';
                let opcionEnvioSeleccionada = 'recojo'; // Por defecto recojo en tienda

                // Configuración de precios
                const precioBase = parseFloat(producto.precio);
                let costoEnvio = 15.00; // Costo base de envío
                const porcentajeIGV = 0.18; // 18% IGV en Perú

                // Variables para dirección de envío
                let direccionEnvio = {
                    departamento: '',
                    provincia: '',
                    distrito: '',
                    direccion: ''
                };

                // Función para calcular costo de envío según ubicación
                function calcularCostoEnvio(departamento, provincia) {
                    if (!departamento) return 0;

                    // Arequipa región y provincia: S/ 5.00 - S/ 20.00
                    if (departamento === 'arequipa' && provincia && provincia.toLowerCase().includes('arequipa')) {
                        return Math.floor(Math.random() * (20 - 5 + 1)) + 5; // Entre 5 y 20
                    }

                    // Nivel nacional: S/ 20.00 - S/ 99.00
                    return Math.floor(Math.random() * (99 - 20 + 1)) + 20; // Entre 20 y 99
                }

                function calcularPrecios() {
                    let subtotal = precioBase;
                    let envio = opcionEnvioSeleccionada === 'envio' ? costoEnvio : 0;
                    let baseImponible = subtotal + envio;
                    let igv = baseImponible * porcentajeIGV;
                    let total = baseImponible + igv;

                    return {
                        subtotal: subtotal,
                        envio: envio,
                        baseImponible: baseImponible,
                        igv: igv,
                        total: total
                    };
                }

                function actualizarResumen() {
                    const precios = calcularPrecios();
                    document.getElementById('resumenSubtotal').textContent = `S/ ${precios.subtotal.toFixed(2)}`;
                    document.getElementById('resumenEnvio').textContent = precios.envio > 0 ? `S/ ${precios.envio.toFixed(2)}` : 'Gratis';
                    document.getElementById('resumenIGV').textContent = `S/ ${precios.igv.toFixed(2)}`;
                    document.getElementById('resumenTotal').textContent = `S/ ${precios.total.toFixed(2)}`;
                }

                document.querySelector('.modal-titulo').textContent = producto.nombre;
                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = `
                <img src="${producto.imagen || 'https://via.placeholder.com/300'}" 
                     alt="${producto.nombre}" 
                     class="producto-imagen-grande" 
                     onerror="this.src='https://via.placeholder.com/300'">
                <div class="producto-precio-badge">S/ ${producto.precio}</div>
                <div class="producto-info-item">
                    <div class="producto-info-label">Color:</div>
                    <div class="producto-info-valor" id="colorChips">
                        ${colores.map((c, i) => `
                            <button type='button' class='chip-color' data-color='${c}' style='background:${getColorHex(c)};border:${colorSeleccionado === c ? '2px solid #007bff' : '2px solid #fff'};margin-right:8px;width:32px;height:32px;border-radius:50%;outline:none;cursor:pointer;vertical-align:middle;box-shadow:0 1px 4px #0001;' title='${c}'></button>
                        `).join('')}
                    </div>
                </div>
                <div class="producto-info-item">
                    <div class="producto-info-label">Talla:</div>
                    <div class="producto-info-valor" id="tallaChips">
                        ${tallas.map(t => `
                            <button type='button' class='chip-talla' data-talla='${t}' style='display:inline-block;margin:0 6px 6px 0;padding:7px 16px;border-radius:16px;border:2px solid #eee;background:${tallaSeleccionada === t ? '#007bff' : '#f8f9fa'};color:${tallaSeleccionada === t ? '#fff' : '#333'};font-weight:600;cursor:pointer;transition:all .2s;'>${t}</button>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Opciones de envío -->
                <div class="opciones-compra">
                    <div class="opciones-titulo">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H11M16 3L19 6H16V3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M15 12L21 18M21 12L15 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Opciones de Entrega
                    </div>
                    
                    <div class="opcion-envio seleccionada" data-tipo="recojo">
                        <div class="opcion-envio-info">
                            <div class="opcion-envio-radio"></div>
                            <div class="opcion-envio-texto">
                                <div class="opcion-envio-nombre">Recojo en Tienda</div>
                                <div class="opcion-envio-descripcion">Retira tu pedido en nuestra tienda física</div>
                            </div>
                        </div>
                        <div class="opcion-envio-precio">Gratis</div>
                    </div>
                    
                    <div class="opcion-envio" data-tipo="envio">
                        <div class="opcion-envio-info">
                            <div class="opcion-envio-radio"></div>
                            <div class="opcion-envio-texto">
                                <div class="opcion-envio-nombre">Envío a Domicilio</div>
                                <div class="opcion-envio-descripcion">Entrega en 2-3 días hábiles</div>
                            </div>
                        </div>
                        <div class="opcion-envio-precio" id="precioEnvioTexto">Desde S/ 5.00</div>
                    </div>
                </div>

                <!-- Formulario de dirección de envío -->
                <div id="formularioDireccion" class="opciones-compra" style="display: none;">
                    <div class="opciones-titulo">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 10C21 17 12 23 12 23S3 17 3 10C3 5.02944 7.02944 1 12 1S21 5.02944 21 10Z" stroke="currentColor" stroke-width="2"/>
                            <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        Dirección de Envío
                    </div>
                    
                    <div style="display: grid; gap: 15px; margin-top: 15px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Departamento/Región:</label>
                            <select id="selectDepartamento" style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 14px;">
                                <option value="">Seleccionar departamento</option>
                                <option value="arequipa">Arequipa</option>
                                <option value="lima">Lima</option>
                                <option value="cusco">Cusco</option>
                                <option value="la-libertad">La Libertad</option>
                                <option value="piura">Piura</option>
                                <option value="lambayeque">Lambayeque</option>
                                <option value="ancash">Ancash</option>
                                <option value="junin">Junín</option>
                                <option value="ica">Ica</option>
                                <option value="tacna">Tacna</option>
                                <option value="moquegua">Moquegua</option>
                                <option value="puno">Puno</option>
                                <option value="ayacucho">Ayacucho</option>
                                <option value="huancavelica">Huancavelica</option>
                                <option value="apurimac">Apurímac</option>
                                <option value="cajamarca">Cajamarca</option>
                                <option value="amazonas">Amazonas</option>
                                <option value="san-martin">San Martín</option>
                                <option value="loreto">Loreto</option>
                                <option value="ucayali">Ucayali</option>
                                <option value="huanuco">Huánuco</option>
                                <option value="pasco">Pasco</option>
                                <option value="madre-de-dios">Madre de Dios</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Provincia:</label>
                            <select id="selectProvincia" style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 14px;" disabled>
                                <option value="">Seleccionar provincia</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Distrito:</label>
                            <select id="selectDistrito" style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 14px;" disabled>
                                <option value="">Seleccionar distrito</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Dirección de envío:</label>
                            <textarea id="inputDireccion" placeholder="Ingresa la dirección completa (calle, número, referencia)" style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 14px; min-height: 60px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; border-left: 4px solid #2196f3;">
                            <div style="font-weight: 600; color: #1976d2; margin-bottom: 5px;">Costo de envío calculado:</div>
                            <div id="costoEnvioCalculado" style="font-size: 16px; font-weight: bold; color: #1976d2;">S/ 0.00</div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                • Arequipa (región y provincia): S/ 5.00 - S/ 20.00<br>
                                • Nivel nacional: S/ 20.00 - S/ 99.00
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen de compra -->
                <div class="resumen-compra">
                    <div class="resumen-titulo">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 11H15M9 15H15M17 21H7C5.89543 21 5 20.1046 5 19V5C5 3.89543 5.89543 3 7 3H12.5858C12.851 3 13.1054 3.10536 13.2929 3.29289L19.7071 9.70711C19.8946 9.89464 20 10.149 20 10.4142V19C20 20.1046 19.1046 21 18 21H17Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Resumen de Compra
                    </div>
                    
                    <div class="resumen-linea">
                        <span>Precio del producto:</span>
                        <span class="precio-original" id="resumenSubtotal">S/ ${precioBase.toFixed(2)}</span>
                    </div>
                    
                    <div class="resumen-linea">
                        <span>Costo de envío:</span>
                        <span class="precio-envio" id="resumenEnvio">Gratis</span>
                    </div>
                    
                    <div class="resumen-linea">
                        <span>IGV (18%):</span>
                        <span class="precio-igv" id="resumenIGV">S/ ${(precioBase * porcentajeIGV).toFixed(2)}</span>
                    </div>
                    
                    <div class="resumen-linea total">
                        <span>Total a pagar:</span>
                        <span class="precio-total" id="resumenTotal">S/ ${(precioBase + (precioBase * porcentajeIGV)).toFixed(2)}</span>
                    </div>
                </div>
                
                <div class="descripcion-section">
                    <div class="descripcion-title">Descripción</div>
                    <textarea class="descripcion-input" readonly>${producto.descripcion || producto.nombre.toLowerCase() + ' bonita'}</textarea>
                </div>
                ${enStock ? `
                <div class="modal-botones">
                    <button class="modal-btn btn-agregar" id="btnAgregarCarrito">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 2L3 6V20C3 21.1046 3.89543 22 5 22H19C20.1046 22 21 21.1046 21 20V6L18 2H6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M16 10C16 13.3137 13.3137 16 10 16C6.68629 16 4 13.3137 4 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Agregar
                    </button>
                    <button class="modal-btn btn-comprar" id="btnComprarDirecto">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 11V7C16 5.93913 15.5786 4.92172 14.8284 4.17157C14.0783 3.42143 13.0609 3 12 3C10.9391 3 9.92172 3.42143 9.17157 4.17157C8.42143 4.92172 8 5.93913 8 7V11M5 11H19L18 21H6L5 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Comprar
                    </button>
                </div>` : `
                <div class="modal-botones">
                    <button class="modal-btn" style="background: #6c757d; color: white;" disabled>
                    Sin Stock
                    </button>
                </div>`}
            `;
                document.getElementById('modalProducto').style.display = 'flex';

                // Eventos para opciones de envío
                document.querySelectorAll('.opcion-envio').forEach(opcion => {
                    opcion.onclick = function () {
                        document.querySelectorAll('.opcion-envio').forEach(o => o.classList.remove('seleccionada'));
                        this.classList.add('seleccionada');
                        opcionEnvioSeleccionada = this.getAttribute('data-tipo');

                        // Mostrar/ocultar formulario de dirección
                        const formularioDireccion = document.getElementById('formularioDireccion');
                        if (opcionEnvioSeleccionada === 'envio') {
                            formularioDireccion.style.display = 'block';
                            // Resetear costo de envío hasta que se complete la dirección
                            costoEnvio = 0;
                        } else {
                            formularioDireccion.style.display = 'none';
                            costoEnvio = 0;
                        }

                        actualizarResumen();
                    };
                });

                // Base de datos de ubicaciones de Perú
                const ubicacionesPeru = {
                    'arequipa': {
                        provincias: {
                            'Arequipa': ['Arequipa', 'Alto Selva Alegre', 'Cayma', 'Cerro Colorado', 'Characato', 'Chiguata', 'Jacobo Hunter', 'La Joya', 'Mariano Melgar', 'Miraflores', 'Mollebaya', 'Paucarpata', 'Pocsi', 'Polobaya', 'Quequeña', 'Sabandia', 'Sachaca', 'San Juan de Siguas', 'San Juan de Tarucani', 'Santa Isabel de Siguas', 'Santa Rita de Siguas', 'Socabaya', 'Tiabaya', 'Uchumayo', 'Vitor', 'Yanahuara', 'Yarabamba', 'Yura'],
                            'Camaná': ['Camaná', 'José María Quimper', 'Mariano Nicolás Valcárcel', 'Mariscal Cáceres', 'Nicolás de Piérola', 'Ocoña', 'Quilca', 'Samuel Pastor'],
                            'Caravelí': ['Caravelí', 'Acarí', 'Atico', 'Atiquipa', 'Bella Unión', 'Cahuacho', 'Chala', 'Chaparra', 'Huanuhuanu', 'Jaqui', 'Lomas', 'Quicacha', 'Yauca'],
                            'Castilla': ['Aplao', 'Andagua', 'Ayo', 'Chachas', 'Chilcaymarca', 'Choco', 'Huancarqui', 'Machaguay', 'Orcopampa', 'Pampacolca', 'Tipan', 'Uñón', 'Uraca', 'Viraco'],
                            'Caylloma': ['Chivay', 'Achoma', 'Cabanaconde', 'Callalli', 'Caylloma', 'Coporaque', 'Huambo', 'Huanca', 'Ichupampa', 'Lari', 'Lluta', 'Maca', 'Madrigal', 'San Antonio de Chuca', 'Sibayo', 'Tapay', 'Tisco', 'Tuti', 'Yanque', 'Majes'],
                            'Condesuyos': ['Chuquibamba', 'Andaray', 'Cayarani', 'Chichas', 'Iray', 'Río Grande', 'Salamanca', 'Yanaquihua'],
                            'Islay': ['Mollendo', 'Cocachacra', 'Dean Valdivia', 'Islay', 'Mejía', 'Punta de Bombón'],
                            'La Unión': ['Cotahuasi', 'Alca', 'Charcana', 'Huaynacotas', 'Pampamarca', 'Puyca', 'Quechualla', 'Sayla', 'Tauria', 'Tomepampa', 'Toro']
                        }
                    },
                    'lima': {
                        provincias: {
                            'Lima': ['Lima', 'Ancón', 'Ate', 'Barranco', 'Breña', 'Carabayllo', 'Chaclacayo', 'Chorrillos', 'Cieneguilla', 'Comas', 'El Agustino', 'Independencia', 'Jesús María', 'La Molina', 'La Victoria', 'Lince', 'Los Olivos', 'Lurigancho', 'Lurín', 'Magdalena del Mar', 'Miraflores', 'Pachacámac', 'Pucusana', 'Pueblo Libre', 'Puente Piedra', 'Punta Hermosa', 'Punta Negra', 'Rímac', 'San Bartolo', 'San Borja', 'San Isidro', 'San Juan de Lurigancho', 'San Juan de Miraflores', 'San Luis', 'San Martín de Porres', 'San Miguel', 'Santa Anita', 'Santa María del Mar', 'Santa Rosa', 'Santiago de Surco', 'Surquillo', 'Villa El Salvador', 'Villa María del Triunfo'],
                            'Barranca': ['Barranca', 'Paramonga', 'Pativilca', 'Supe', 'Supe Puerto'],
                            'Cajatambo': ['Cajatambo', 'Copa', 'Gorgor', 'Huancapón', 'Manas'],
                            'Canta': ['Canta', 'Arahuay', 'Huamantanga', 'Huaros', 'Lachaqui', 'San Buenaventura', 'Santa Rosa de Quives'],
                            'Cañete': ['San Vicente de Cañete', 'Asia', 'Calango', 'Cerro Azul', 'Chilca', 'Coayllo', 'Imperial', 'Lunahuaná', 'Mala', 'Nuevo Imperial', 'Pacarán', 'Quilmaná', 'San Antonio', 'San Luis', 'Santa Cruz de Flores', 'Zúñiga'],
                            'Huaral': ['Huaral', 'Atavillos Alto', 'Atavillos Bajo', 'Aucallama', 'Chancay', 'Ihuarí', 'Lampián', 'Pacaraos', 'San Miguel de Acos', 'Santa Cruz de Andamarca', 'Sumbilca', 'Veintisiete de Noviembre'],
                            'Huarochirí': ['Matucana', 'Antioquia', 'Callahuanca', 'Carampoma', 'Chicla', 'Cuenca', 'Huachupampa', 'Huanza', 'Huarochirí', 'Lahuaytambo', 'Langa', 'Laraos', 'Mariatana', 'Ricardo Palma', 'San Andrés de Tupicocha', 'San Antonio', 'San Bartolomé', 'San Damián', 'San Juan de Iris', 'San Juan de Tantaranche', 'San Lorenzo de Quinti', 'San Mateo', 'San Mateo de Otao', 'San Pedro de Casta', 'San Pedro de Huancayre', 'Sangallaya', 'Santa Cruz de Cocachacra', 'Santa Eulalia', 'Santiago de Anchucaya', 'Santiago de Tuna', 'Santo Domingo de los Olleros', 'Surco'],
                            'Huaura': ['Huacho', 'Ambar', 'Caleta de Carquín', 'Checras', 'Hualmay', 'Huaura', 'Leoncio Prado', 'Paccho', 'Santa Leonor', 'Santa María', 'Sayán', 'Vegueta'],
                            'Oyón': ['Oyón', 'Andajes', 'Caujul', 'Cochamarca', 'Navan', 'Pachangara'],
                            'Yauyos': ['Yauyos', 'Alis', 'Ayauca', 'Ayaviri', 'Azángaro', 'Cacra', 'Carania', 'Catahuasi', 'Chocos', 'Cochas', 'Colonia', 'Hongos', 'Huampara', 'Huancaya', 'Huangascar', 'Huantán', 'Huañec', 'Laraos', 'Lincha', 'Madean', 'Miraflores', 'Omas', 'Putinza', 'Quinches', 'Quinocay', 'San Joaquín', 'San Pedro de Pilas', 'Tanta', 'Tauripampa', 'Tomas', 'Tupe', 'Viñac', 'Vitis']
                        }
                    },
                    'cusco': {
                        provincias: {
                            'Cusco': ['Cusco', 'Ccorca', 'Poroy', 'San Jerónimo', 'San Sebastián', 'Santiago', 'Saylla', 'Wanchaq'],
                            'Acomayo': ['Acomayo', 'Acopia', 'Acos', 'Mosoc Llacta', 'Pomacanchi', 'Rondocan', 'Sangarará'],
                            'Anta': ['Anta', 'Ancahuasi', 'Cachimayo', 'Chinchaypujio', 'Huarocondo', 'Limatambo', 'Mollepata', 'Pucyura', 'Zurite'],
                            'Calca': ['Calca', 'Coya', 'Lamay', 'Lares', 'Pisac', 'San Salvador', 'Taray', 'Yanatile'],
                            'Canas': ['Yanaoca', 'Checca', 'Kunturkanki', 'Langui', 'Layo', 'Pampamarca', 'Quehue', 'Túpac Amaru'],
                            'Canchis': ['Sicuani', 'Checacupe', 'Combapata', 'Marangani', 'Pitumarca', 'San Pablo', 'San Pedro', 'Tinta'],
                            'Chumbivilcas': ['Santo Tomás', 'Capacmarca', 'Chamaca', 'Colquemarca', 'Livitaca', 'Llusco', 'Quiñota', 'Velille'],
                            'Espinar': ['Espinar', 'Condoroma', 'Coporaque', 'Occoruro', 'Pallpata', 'Pichigua', 'Suyckutambo', 'Alto Pichigua'],
                            'La Convención': ['Santa Ana', 'Echarate', 'Huayopata', 'Maranura', 'Ocobamba', 'Quellouno', 'Kimbiri', 'Santa Teresa', 'Vilcabamba', 'Pichari', 'Inkawasi', 'Villa Virgen', 'Villa Kintiarina', 'Megantoni'],
                            'Paruro': ['Paruro', 'Accha', 'Ccapi', 'Colcha', 'Huanoquite', 'Omacha', 'Paccaritambo', 'Pillpinto', 'Yaurisque'],
                            'Paucartambo': ['Paucartambo', 'Caicay', 'Challabamba', 'Colquepata', 'Huancarani', 'Kosñipata'],
                            'Quispicanchi': ['Urcos', 'Andahuaylillas', 'Camanti', 'Ccarhuayo', 'Ccatca', 'Cusipata', 'Huaro', 'Lucre', 'Marcapata', 'Ocongate', 'Oropesa', 'Quiquijana'],
                            'Urubamba': ['Urubamba', 'Chinchero', 'Huayllabamba', 'Machupicchu', 'Maras', 'Ollantaytambo', 'Yucay']
                        }
                    },
                    'la-libertad': {
                        provincias: {
                            'Trujillo': ['Trujillo', 'El Porvenir', 'Florencia de Mora', 'Huanchaco', 'La Esperanza', 'Laredo', 'Moche', 'Poroto', 'Salaverry', 'Simbal', 'Víctor Larco Herrera'],
                            'Ascope': ['Ascope', 'Chicama', 'Chocope', 'Magdalena de Cao', 'Paiján', 'Rázuri', 'Santiago de Cao', 'Casa Grande'],
                            'Bolívar': ['Bolívar', 'Bambamarca', 'Condormarca', 'Longotea', 'Uchumarca', 'Ucuncha'],
                            'Chepén': ['Chepén', 'Pacanga', 'Pueblo Nuevo'],
                            'Julcán': ['Julcán', 'Calamarca', 'Carabamba', 'Huaso'],
                            'Otuzco': ['Otuzco', 'Agallpampa', 'Charat', 'Huaranchal', 'La Cuesta', 'Mache', 'Paranday', 'Salpo', 'Sinsicap', 'Usquil'],
                            'Pacasmayo': ['San Pedro de Lloc', 'Guadalupe', 'Jequetepeque', 'Pacasmayo', 'San José'],
                            'Pataz': ['Tayabamba', 'Buldibuyo', 'Chillia', 'Huancaspata', 'Huaylillas', 'Huayo', 'Ongón', 'Parcoy', 'Pataz', 'Pías', 'Santiago de Challas', 'Taurija', 'Urpay'],
                            'Sánchez Carrión': ['Huamachuco', 'Chugay', 'Cochorco', 'Curgos', 'Marcabal', 'Sanagoran', 'Sarin', 'Sartimbamba'],
                            'Santiago de Chuco': ['Santiago de Chuco', 'Angasmarca', 'Cachicadán', 'Mollebamba', 'Mollepata', 'Quiruvilca', 'Santa Cruz de Chuca', 'Sitabamba'],
                            'Gran Chimú': ['Cascas', 'Lucma', 'Marmot', 'Sayapullo'],
                            'Virú': ['Virú', 'Chao', 'Guadalupito']
                        }
                    },
                    'piura': {
                        provincias: {
                            'Piura': ['Piura', 'Castilla', 'Catacaos', 'Cura Mori', 'El Tallán', 'La Arena', 'La Unión', 'Las Lomas', 'Tambo Grande', 'Veintiseis de Octubre'],
                            'Ayabaca': ['Ayabaca', 'Frías', 'Jililí', 'Lagunas', 'Montero', 'Pacaipampa', 'Paimas', 'Sapillica', 'Sicchez', 'Suyo'],
                            'Huancabamba': ['Huancabamba', 'Canchaque', 'El Carmen de la Frontera', 'Huarmaca', 'Lalaquiz', 'San Miguel de El Faique', 'Sóndor', 'Sondorillo'],
                            'Morropón': ['Chulucanas', 'Buenos Aires', 'Chalaco', 'La Matanza', 'Morropón', 'Salitral', 'San Juan de Bigote', 'Santa Catalina de Mossa', 'Santo Domingo', 'Yamango'],
                            'Paita': ['Paita', 'Amotape', 'Arenal', 'Colán', 'La Huaca', 'Tamarindo', 'Vichayal'],
                            'Sullana': ['Sullana', 'Bellavista', 'Ignacio Escudero', 'Lancones', 'Marcavelica', 'Miguel Checa', 'Querecotillo', 'Salitral'],
                            'Talara': ['Pariñas', 'El Alto', 'La Brea', 'Lobitos', 'Los Órganos', 'Máncora'],
                            'Sechura': ['Sechura', 'Bellavista de la Unión', 'Bernal', 'Cristo Nos Valga', 'Vice', 'Rinconada Llicuar']
                        }
                    },
                    'lambayeque': {
                        provincias: {
                            'Chiclayo': ['Chiclayo', 'Chongoyape', 'Eten', 'Eten Puerto', 'José Leonardo Ortiz', 'La Victoria', 'Lagunas', 'Monsefú', 'Nueva Arica', 'Oyotún', 'Picsi', 'Pimentel', 'Reque', 'Santa Rosa', 'Saña', 'Cayaltí', 'Pátapo', 'Pomalca', 'Pucalá', 'Tumán'],
                            'Ferreñafe': ['Ferreñafe', 'Cañaris', 'Incahuasi', 'Manuel Antonio Mesones Muro', 'Pítipo', 'Pueblo Nuevo'],
                            'Lambayeque': ['Lambayeque', 'Chóchope', 'Illimo', 'Jayanca', 'Mochumi', 'Mórrope', 'Motupe', 'Olmos', 'Pacora', 'Salas', 'San José', 'Túcume']
                        }
                    },
                    'ancash': {
                        provincias: {
                            'Huaraz': ['Huaraz', 'Cochabamba', 'Colcabamba', 'Huanchay', 'Independencia', 'Jangas', 'La Libertad', 'Olleros', 'Pampas Grande', 'Pariacoto', 'Pira', 'Tarica'],
                            'Aija': ['Aija', 'Coris', 'Huacllán', 'La Merced', 'Succha'],
                            'Antonio Raymondi': ['Llamellín', 'Aczo', 'Chaccho', 'Chingas', 'Mirgas', 'San Juan de Rontoy'],
                            'Asunción': ['Chacas', 'Acochaca'],
                            'Bolognesi': ['Chiquián', 'Abelardo Pardo Lezameta', 'Antonio Raymondi', 'Aquia', 'Cajacay', 'Canis', 'Colquioc', 'Huallanca', 'Huasta', 'Huayllacayán', 'La Primavera', 'Mangas', 'Pacllon', 'San Miguel de Corpanqui', 'Ticllos'],
                            'Carhuaz': ['Carhuaz', 'Acopampa', 'Amashca', 'Anta', 'Ataquero', 'Marcará', 'Pariahuanca', 'San Miguel de Aco', 'Shilla', 'Tinco', 'Yungar'],
                            'Carlos Fermín Fitzcarrald': ['San Luis', 'San Nicolás', 'Yauya'],
                            'Casma': ['Casma', 'Buena Vista Alta', 'Comandante Noel', 'Yaután'],
                            'Corongo': ['Corongo', 'Aco', 'Bambas', 'Cusca', 'La Pampa', 'Yanac', 'Yupán'],
                            'Huari': ['Huari', 'Anra', 'Cajay', 'Chavin de Huantar', 'Huacachi', 'Huacchis', 'Huachis', 'Huantar', 'Masin', 'Paucas', 'Ponto', 'Rahuapampa', 'Rapayán', 'San Marcos', 'San Pedro de Chaná', 'Uco'],
                            'Huarmey': ['Huarmey', 'Cochapeti', 'Culebras', 'Huayán', 'Malvas'],
                            'Huaylas': ['Caraz', 'Huallanca', 'Huata', 'Huaylas', 'Mato', 'Pamparomas', 'Pueblo Libre', 'Santa Cruz', 'Santo Toribio', 'Yuracmarca'],
                            'Mariscal Luzuriaga': ['Piscobamba', 'Casca', 'Eleazar Guzmán Barron', 'Fidel Olivas Escudero', 'Llama', 'Llumpa', 'Lucma', 'Musga'],
                            'Ocros': ['Ocros', 'Acas', 'Cajamarquilla', 'Carhuapampa', 'Cochas', 'Congas', 'Llipa', 'San Cristóbal de Rajan', 'San Pedro', 'Santiago de Chilcas'],
                            'Pallasca': ['Cabana', 'Bolognesi', 'Conchucos', 'Huacaschuque', 'Huandoval', 'Lacabamba', 'Llapo', 'Pallasca', 'Pampas', 'Santa Rosa', 'Tauca'],
                            'Pomabamba': ['Pomabamba', 'Huayllan', 'Parobamba', 'Quinuabamba'],
                            'Recuay': ['Recuay', 'Catac', 'Cotaparaco', 'Huayllapampa', 'Llacllin', 'Marca', 'Pampas Chico', 'Pararin', 'Tapacocha', 'Ticapampa'],
                            'Santa': ['Chimbote', 'Cáceres del Perú', 'Coishco', 'Macate', 'Moro', 'Nepeña', 'Samanco', 'Santa', 'Nuevo Chimbote'],
                            'Sihuas': ['Sihuas', 'Acobamba', 'Alfonso Ugarte', 'Cashapampa', 'Chingalpo', 'Huayllabamba', 'Quiches', 'Ragash', 'San Juan', 'Sicsibamba'],
                            'Yungay': ['Yungay', 'Cascapara', 'Mancos', 'Matacoto', 'Quillo', 'Ranrahirca', 'Shupluy', 'Yanama']
                        }
                    },
                    'junin': {
                        provincias: {
                            'Huancayo': ['Huancayo', 'Carhuacallanga', 'Chacapampa', 'Chicche', 'Chilca', 'Chongos Alto', 'Chupuro', 'Colca', 'Cullhuas', 'El Tambo', 'Huacrapuquio', 'Hualhuas', 'Huancan', 'Huasicancha', 'Huayucachi', 'Ingenio', 'Pariahuanca', 'Pilcomayo', 'Pucara', 'Quichuay', 'Quilcas', 'San Agustin', 'San Jeronimo de Tunan', 'Saño', 'Sapallanga', 'Sicaya', 'Santo Domingo de Acobamba', 'Viques'],
                            'Concepción': ['Concepción', 'Aco', 'Andamarca', 'Chambara', 'Cochas', 'Comas', 'Heroinas Toledo', 'Manzanares', 'Mariscal Castilla', 'Matahuasi', 'Mito', 'Nueve de Julio', 'Orcotuna', 'San Jose de Quero', 'Santa Rosa de Ocopa'],
                            'Chanchamayo': ['La Merced', 'Chanchamayo', 'Perene', 'Pichanaqui', 'San Luis de Shuaro', 'San Ramon', 'Vitoc'],
                            'Jauja': ['Jauja', 'Acolla', 'Apata', 'Ataura', 'Canchayllo', 'Curicaca', 'El Mantaro', 'Huamali', 'Huaripampa', 'Huertas', 'Janjaillo', 'Julcan', 'Leonor Ordoñez', 'Llocllapampa', 'Marco', 'Masma', 'Masma Chicche', 'Molinos', 'Monobamba', 'Muqui', 'Muquiyauyo', 'Paca', 'Paccha', 'Pancan', 'Parco', 'Pomacancha', 'Ricran', 'San Lorenzo', 'San Pedro de Chunan', 'Sausa', 'Sincos', 'Tunan Marca', 'Yauli', 'Yauyos'],
                            'Junín': ['Junín', 'Carhuamayo', 'Ondores', 'Ulcumayo'],
                            'Satipo': ['Satipo', 'Coviriali', 'Llaylla', 'Mazamari', 'Pampa Hermosa', 'Pangoa', 'Rio Negro', 'Rio Tambo'],
                            'Tarma': ['Tarma', 'Acobamba', 'Huaricolca', 'Huasahuasi', 'La Union', 'Palca', 'Palcamayo', 'San Pedro de Cajas', 'Tapo'],
                            'Yauli': ['La Oroya', 'Chacapalpa', 'Huay-Huay', 'Marcapomacocha', 'Morococha', 'Paccha', 'Santa Barbara de Carhuacayan', 'Santa Rosa de Sacco', 'Suitucancha', 'Yauli'],
                            'Chupaca': ['Chupaca', 'Ahuac', 'Chongos Bajo', 'Huachac', 'Huamancaca Chico', 'San Juan de Iscos', 'San Juan de Jarpa', 'Tres de Diciembre', 'Yanacancha']
                        }
                    },
                    'ica': {
                        provincias: {
                            'Ica': ['Ica', 'La Tinguiña', 'Los Aquijes', 'Ocucaje', 'Pachacutec', 'Parcona', 'Pueblo Nuevo', 'Salas', 'San José de Los Molinos', 'San Juan Bautista', 'Santiago', 'Subtanjalla', 'Tate', 'Yauca del Rosario'],
                            'Chincha': ['Chincha Alta', 'Alto Laran', 'Chavin', 'Chincha Baja', 'El Carmen', 'Grocio Prado', 'Pueblo Nuevo', 'San Juan de Yanac', 'San Pedro de Huacarpana', 'Sunampe', 'Tambo de Mora'],
                            'Nazca': ['Nazca', 'Changuillo', 'El Ingenio', 'Marcona', 'Vista Alegre'],
                            'Palpa': ['Palpa', 'Llipata', 'Rio Grande', 'Santa Cruz', 'Tibillo'],
                            'Pisco': ['Pisco', 'Huancano', 'Humay', 'Independencia', 'Paracas', 'San Andres', 'San Clemente', 'Tupac Amaru Inca']
                        }
                    },
                    'tacna': {
                        provincias: {
                            'Tacna': ['Tacna', 'Alto de la Alianza', 'Calana', 'Ciudad Nueva', 'Inclan', 'Pachia', 'Palca', 'Pocollay', 'Sama', 'Coronel Gregorio Albarracín Lanchipa'],
                            'Candarave': ['Candarave', 'Cairani', 'Camilaca', 'Curibaya', 'Huanuara', 'Quilahuani'],
                            'Jorge Basadre': ['Locumba', 'Ilabaya', 'Ite'],
                            'Tarata': ['Tarata', 'Chucatamani', 'Estique', 'Estique-Pampa', 'Sitajara', 'Susapaya', 'Tarucachi', 'Ticaco']
                        }
                    },
                    'moquegua': {
                        provincias: {
                            'Mariscal Nieto': ['Moquegua', 'Carumas', 'Cuchumbaya', 'Samegua', 'San Cristóbal', 'Torata'],
                            'General Sánchez Cerro': ['Omate', 'Chojata', 'Coalaque', 'Ichuña', 'La Capilla', 'Lloque', 'Matalaque', 'Puquina', 'Quinistaquillas', 'Ubinas', 'Yunga'],
                            'Ilo': ['Ilo', 'El Algarrobal', 'Pacocha']
                        }
                    },
                    'puno': {
                        provincias: {
                            'Puno': ['Puno', 'Acora', 'Amantani', 'Atuncolla', 'Capachica', 'Chucuito', 'Coata', 'Huata', 'Mañazo', 'Paucarcolla', 'Pichacani', 'Plateria', 'San Antonio', 'Tiquillaca', 'Vilque'],
                            'Azángaro': ['Azángaro', 'Achaya', 'Arapa', 'Asillo', 'Caminaca', 'Chupa', 'José Domingo Choquehuanca', 'Muñani', 'Potoni', 'Saman', 'San Anton', 'San José', 'San Juan de Salinas', 'Santiago de Pupuja', 'Tirapata'],
                            'Carabaya': ['Macusani', 'Ajoyani', 'Ayapata', 'Coasa', 'Corani', 'Crucero', 'Ituata', 'Ollachea', 'San Gaban', 'Usicayos'],
                            'Chucuito': ['Juli', 'Desaguadero', 'Huacullani', 'Kelluyo', 'Pisacoma', 'Pomata', 'Zepita'],
                            'El Collao': ['Ilave', 'Capazo', 'Pilcuyo', 'Santa Rosa', 'Conduriri'],
                            'Huancané': ['Huancané', 'Cojata', 'Huatasani', 'Inchupalla', 'Pusi', 'Rosaspata', 'Taraco', 'Vilque Chico'],
                            'Lampa': ['Lampa', 'Cabanilla', 'Calapuja', 'Nicasio', 'Ocuviri', 'Palca', 'Paratia', 'Pucara', 'Santa Lucia', 'Vilavila'],
                            'Melgar': ['Ayaviri', 'Antauta', 'Cupi', 'Llalli', 'Macari', 'Nuñoa', 'Orurillo', 'Santa Rosa', 'Umachiri'],
                            'Moho': ['Moho', 'Conima', 'Huayrapata', 'Tilali'],
                            'San Antonio de Putina': ['Putina', 'Ananea', 'Pedro Vilca Apaza', 'Quilcapuncu', 'Sina'],
                            'San Román': ['Juliaca', 'Cabana', 'Cabanillas', 'Caracoto'],
                            'Sandia': ['Sandia', 'Cuyocuyo', 'Limbani', 'Patambuco', 'Phara', 'Quiaca', 'San Juan del Oro', 'Yanahuaya', 'Alto Inambari', 'San Pedro de Putina Punco'],
                            'Yunguyo': ['Yunguyo', 'Anapia', 'Copani', 'Cuturapi', 'Ollaraya', 'Tinicachi', 'Unicachi']
                        }
                    }
                };

                // Eventos para el formulario de dirección
                const selectDepartamento = document.getElementById('selectDepartamento');
                const selectProvincia = document.getElementById('selectProvincia');
                const selectDistrito = document.getElementById('selectDistrito');
                const inputDireccion = document.getElementById('inputDireccion');

                // Función para cargar provincias según departamento
                function cargarProvincias(departamento) {
                    const selectProvincia = document.getElementById('selectProvincia');
                    const selectDistrito = document.getElementById('selectDistrito');

                    // Limpiar selectores
                    selectProvincia.innerHTML = '<option value="">Seleccionar provincia</option>';
                    selectDistrito.innerHTML = '<option value="">Seleccionar distrito</option>';
                    selectDistrito.disabled = true;

                    if (departamento && ubicacionesPeru[departamento]) {
                        selectProvincia.disabled = false;
                        const provincias = ubicacionesPeru[departamento].provincias;

                        Object.keys(provincias).forEach(provincia => {
                            const option = document.createElement('option');
                            option.value = provincia;
                            option.textContent = provincia;
                            selectProvincia.appendChild(option);
                        });
                    } else {
                        selectProvincia.disabled = true;
                    }
                }

                // Función para cargar distritos según provincia
                function cargarDistritos(departamento, provincia) {
                    const selectDistrito = document.getElementById('selectDistrito');

                    // Limpiar selector
                    selectDistrito.innerHTML = '<option value="">Seleccionar distrito</option>';

                    if (departamento && provincia && ubicacionesPeru[departamento] && ubicacionesPeru[departamento].provincias[provincia]) {
                        selectDistrito.disabled = false;
                        const distritos = ubicacionesPeru[departamento].provincias[provincia];

                        distritos.forEach(distrito => {
                            const option = document.createElement('option');
                            option.value = distrito;
                            option.textContent = distrito;
                            selectDistrito.appendChild(option);
                        });
                    } else {
                        selectDistrito.disabled = true;
                    }
                }

                function actualizarCostoEnvio() {
                    if (opcionEnvioSeleccionada === 'envio') {
                        const departamento = selectDepartamento.value;
                        const provincia = selectProvincia.value;
                        const distrito = selectDistrito.value;

                        if (departamento && provincia && distrito) {
                            costoEnvio = calcularCostoEnvio(departamento, provincia);
                            document.getElementById('costoEnvioCalculado').textContent = `S/ ${costoEnvio.toFixed(2)}`;

                            // Guardar datos de dirección
                            direccionEnvio = {
                                departamento: departamento,
                                provincia: provincia,
                                distrito: distrito,
                                direccion: inputDireccion.value
                            };

                            actualizarResumen();
                        } else {
                            costoEnvio = 0;
                            document.getElementById('costoEnvioCalculado').textContent = 'S/ 0.00';
                            actualizarResumen();
                        }
                    }
                }

                // Event listeners para los selectores
                selectDepartamento.addEventListener('change', function () {
                    const departamento = this.value;
                    cargarProvincias(departamento);
                    actualizarCostoEnvio();
                });

                selectProvincia.addEventListener('change', function () {
                    const departamento = selectDepartamento.value;
                    const provincia = this.value;
                    cargarDistritos(departamento, provincia);
                    actualizarCostoEnvio();
                });

                selectDistrito.addEventListener('change', actualizarCostoEnvio);
                inputDireccion.addEventListener('input', actualizarCostoEnvio);

                // Eventos para chips de color
                document.querySelectorAll('.chip-color').forEach(btn => {
                    btn.onclick = function () {
                        colorSeleccionado = btn.getAttribute('data-color');
                        document.querySelectorAll('.chip-color').forEach(b => b.style.border = '2px solid #fff');
                        btn.style.border = '2px solid #007bff';
                    };
                });
                // Eventos para chips de talla
                document.querySelectorAll('.chip-talla').forEach(btn => {
                    btn.onclick = function () {
                        tallaSeleccionada = btn.getAttribute('data-talla');
                        document.querySelectorAll('.chip-talla').forEach(b => {
                            b.style.background = '#f8f9fa';
                            b.style.color = '#333';
                        });
                        btn.style.background = '#007bff';
                        btn.style.color = '#fff';
                    };
                });
                if (enStock) {
                    document.getElementById('btnAgregarCarrito').onclick = function () {
                        if (!tallaSeleccionada) {
                            mostrarToast('Selecciona una talla', 'error');
                            return;
                        }
                        if (!colorSeleccionado) {
                            mostrarToast('Selecciona un color', 'error');
                            return;
                        }

                        // Validar dirección si se seleccionó envío
                        if (opcionEnvioSeleccionada === 'envio') {
                            if (!direccionEnvio.departamento || !direccionEnvio.provincia || !direccionEnvio.distrito || !direccionEnvio.direccion) {
                                mostrarToast('Completa todos los datos de dirección de envío', 'error');
                                return;
                            }
                        }

                        const precios = calcularPrecios();
                        agregarAlCarrito(producto.id, null, tallaSeleccionada, colorSeleccionado, opcionEnvioSeleccionada, precios.total, direccionEnvio);
                    };

                    document.getElementById('btnComprarDirecto').onclick = function () {
                        if (!tallaSeleccionada) {
                            mostrarToast('Selecciona una talla', 'error');
                            return;
                        }
                        if (!colorSeleccionado) {
                            mostrarToast('Selecciona un color', 'error');
                            return;
                        }

                        // Validar dirección si se seleccionó envío
                        if (opcionEnvioSeleccionada === 'envio') {
                            if (!direccionEnvio.departamento || !direccionEnvio.provincia || !direccionEnvio.distrito || !direccionEnvio.direccion) {
                                mostrarToast('Completa todos los datos de dirección de envío', 'error');
                                return;
                            }
                        }

                        const precios = calcularPrecios();
                        console.log('Datos a enviar:', {
                            producto: producto.id,
                            talla: tallaSeleccionada,
                            color: colorSeleccionado,
                            tipoEnvio: opcionEnvioSeleccionada,
                            direccion: direccionEnvio,
                            costoEnvio: costoEnvio,
                            precios: precios
                        });

                        // Crear objeto completo del producto con toda la información
                        const productoCompleto = {
                            ...producto,
                            talla: tallaSeleccionada,
                            color: colorSeleccionado,
                            tipoEnvio: opcionEnvioSeleccionada,
                            costoEnvio: costoEnvio,
                            direccionEnvio: direccionEnvio,
                            precioTotal: precios.total
                        };

                        comprarDirecto(producto.id, tallaSeleccionada, colorSeleccionado, opcionEnvioSeleccionada, precios.total, direccionEnvio, costoEnvio);
                    };
                }
            };

            // Función para obtener color HEX según nombre común
            function getColorHex(nombre) {
                const mapa = {
                    'Negro': '#000000',
                    'Blanco': '#ffffff',
                    'Azul': '#0066cc',
                    'Rojo': '#cc0000',
                    'Verde': '#00cc00',
                    'Gris': '#666666',
                    'Amarillo': '#ffcc00',
                    'Rosa': '#ff69b4',
                    'Celeste': '#00cfff',
                    'Naranja': '#ff9900',
                    'Marrón': '#8B4513',
                    'Morado': '#800080',
                    'Violeta': '#9400D3',
                    'Turquesa': '#40e0d0',
                    'Dorado': '#ffd700',
                    'Plateado': '#c0c0c0',
                    'Fucsia': '#e040fb',
                    'Lima': '#bfff00',
                    'Oliva': '#808000',
                    'Azul Marino': '#001f3f',
                    '': '#eee'
                };
                return mapa[nombre] || nombre || '#eee';
            }

            // Cerrar modal
            window.cerrarModal = function () {
                document.getElementById('modalProducto').style.display = 'none';
            };

            // Modificar agregarAlCarrito para guardar talla, color, envío, precio total y dirección
            window.agregarAlCarrito = function (id, botonElement, talla, color, tipoEnvio, precioTotal, direccion) {
                const producto = productos.find(p => p.id === id);
                if (!producto || producto.stock <= 0) {
                    mostrarToast('Producto sin stock disponible', 'error');
                    return;
                }
                if (!talla) {
                    mostrarToast('Selecciona una talla', 'error');
                    return;
                }
                if (!color) {
                    mostrarToast('Selecciona un color', 'error');
                    return;
                }
                // Efecto visual en el botón
                if (botonElement) {
                    botonElement.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        botonElement.style.transform = '';
                    }, 150);
                }
                const itemEnCarrito = carrito.find(item => item.id === id && item.talla === talla && item.color === color && item.tipoEnvio === tipoEnvio);
                if (itemEnCarrito) {
                    itemEnCarrito.cantidad++;
                    mostrarToast(`${producto.nombre} (${talla}, ${color}) agregado al carrito (cantidad: ${itemEnCarrito.cantidad})`);
                } else {
                    carrito.push({
                        id: producto.id,
                        nombre: producto.nombre,
                        precio: producto.precio,
                        precioTotal: precioTotal || producto.precio,
                        imagen: producto.imagen,
                        talla: talla,
                        color: color,
                        tipoEnvio: tipoEnvio || 'recojo',
                        direccionEnvio: direccion || null,
                        cantidad: 1
                    });
                    const tipoEnvioTexto = tipoEnvio === 'envio' ? 'con envío' : 'recojo en tienda';
                    mostrarToast(`${producto.nombre} (${talla}, ${color}, ${tipoEnvioTexto}) agregado al carrito`);
                }
                localStorage.setItem('carrito', JSON.stringify(carrito));
                actualizarContadorCarrito();
                if (document.getElementById('modalProducto').style.display === 'flex') {
                    cerrarModal();
                }
            };

            // Actualizar contador del carrito
            function actualizarContadorCarrito() {
                const contador = document.getElementById('carritoContador');
                const totalItems = carrito.reduce((total, item) => total + item.cantidad, 0);

                if (totalItems > 0) {
                    contador.textContent = totalItems;
                    contador.style.display = 'flex';
                } else {
                    contador.style.display = 'none';
                }
            }

            // Abrir carrito
            window.abrirCarrito = function () {
                const modalCarrito = document.getElementById('modalCarrito');
                const carritoBody = document.getElementById('carritoBody');

                if (carrito.length === 0) {
                    carritoBody.innerHTML = `
                    <div class="carrito-vacio">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 7L4 7L6 21L18 21L20 7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <p>Tu carrito está vacío</p>
                    </div>`;
                } else {
                    let html = '';
                    let subtotalGeneral = 0;
                    let envioTotal = 0;
                    let igvTotal = 0;

                    carrito.forEach(item => {
                        const precioBase = parseFloat(item.precio);
                        const costoEnvio = item.tipoEnvio === 'envio' ? 15.00 : 0;
                        const baseImponible = (precioBase + costoEnvio) * item.cantidad;
                        const igvItem = baseImponible * 0.18;
                        const totalItem = baseImponible + igvItem;

                        subtotalGeneral += precioBase * item.cantidad;
                        envioTotal += costoEnvio * item.cantidad;
                        igvTotal += igvItem;

                        const tipoEnvioTexto = item.tipoEnvio === 'envio' ? 'Con envío' : 'Recojo en tienda';

                        html += `
                        <div class="carrito-item">
                            <img src="${item.imagen || 'https://via.placeholder.com/60'}" 
                                 alt="${item.nombre}" 
                                 class="carrito-item-imagen"
                                 onerror="this.src='https://via.placeholder.com/60'">
                            <div class="carrito-item-info">
                                <div class="carrito-item-nombre">${item.nombre}</div>
                                <div class="carrito-item-detalles">
                                    <span class="carrito-item-talla">Talla: ${item.talla}</span>
                                    <span class="carrito-item-color">Color: ${item.color}</span>
                                    <span class="carrito-item-envio">${tipoEnvioTexto}</span>
                                    ${item.tipoEnvio === 'envio' && item.direccionEnvio ? `
                                        <div style="margin-top: 8px; padding: 8px; background: #f0f8ff; border-radius: 6px; font-size: 11px; color: #1976d2;">
                                            <strong>Envío a:</strong><br>
                                            ${item.direccionEnvio.departamento.charAt(0).toUpperCase() + item.direccionEnvio.departamento.slice(1)}, ${item.direccionEnvio.provincia}, ${item.direccionEnvio.distrito}<br>
                                            <span style="color: #666;">${item.direccionEnvio.direccion}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="carrito-item-precio">S/ ${precioBase.toFixed(2)} c/u</div>
                                <div class="carrito-item-cantidad">
                                    <button class="cantidad-btn" onclick="cambiarCantidad('${item.id}', -1, '${item.talla}', '${item.color}', '${item.tipoEnvio}')">-</button>
                                    <span class="cantidad-numero">${item.cantidad}</span>
                                    <button class="cantidad-btn" onclick="cambiarCantidad('${item.id}', 1, '${item.talla}', '${item.color}', '${item.tipoEnvio}')">+</button>
                                </div>
                                <div class="carrito-item-total">Total: S/ ${totalItem.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                    });

                    const totalFinal = subtotalGeneral + envioTotal + igvTotal;

                    html += `
                    <div class="carrito-resumen">
                        <div class="carrito-resumen-linea">
                            <span>Subtotal productos:</span>
                            <span>S/ ${subtotalGeneral.toFixed(2)}</span>
                        </div>
                        <div class="carrito-resumen-linea">
                            <span>Costo de envío:</span>
                            <span>S/ ${envioTotal.toFixed(2)}</span>
                        </div>
                        <div class="carrito-resumen-linea">
                            <span>IGV (18%):</span>
                            <span>S/ ${igvTotal.toFixed(2)}</span>
                        </div>
                        <div class="carrito-total">
                            <span>Total a pagar:</span>
                            <span>S/ ${totalFinal.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="carrito-botones">
                        <button class="carrito-btn btn-vaciar" onclick="vaciarCarrito()">Vaciar</button>
                        <button class="carrito-btn btn-comprar" onclick="comprarCarrito()">Comprar</button>
                    </div>
                `;

                    carritoBody.innerHTML = html;
                }

                modalCarrito.style.display = 'flex';
            };

            // Cerrar carrito
            window.cerrarCarrito = function () {
                document.getElementById('modalCarrito').style.display = 'none';
            };

            // Cambiar cantidad de un producto
            window.cambiarCantidad = function (id, cambio, talla, color, tipoEnvio) {
                const item = carrito.find(i => i.id === id && i.talla === talla && i.color === color && i.tipoEnvio === tipoEnvio);
                if (item) {
                    item.cantidad += cambio;
                    if (item.cantidad <= 0) {
                        carrito = carrito.filter(i => !(i.id === id && i.talla === talla && i.color === color && i.tipoEnvio === tipoEnvio));
                    }
                    localStorage.setItem('carrito', JSON.stringify(carrito));
                    actualizarContadorCarrito();
                    abrirCarrito(); // Actualizar vista del carrito
                }
            };

            // Vaciar carrito
            window.vaciarCarrito = function () {
                if (confirm('¿Estás seguro de que quieres vaciar el carrito?')) {
                    carrito = [];
                    localStorage.setItem('carrito', JSON.stringify(carrito));
                    actualizarContadorCarrito();
                    abrirCarrito(); // Actualizar vista del carrito
                }
            };

            // Función para generar número de pedido
            function generarNumeroPedido() {
                const fecha = new Date();
                const año = fecha.getFullYear().toString().slice(-2);
                const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
                const dia = fecha.getDate().toString().padStart(2, '0');
                const aleatorio = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
                return `PED${año}${mes}${dia}${aleatorio}`;
            }



            // Función para realizar compra usando chat interno
            window.realizarCompra = async function () {
                if (chatCliente) {
                    chatCliente.mostrarSeleccionAsesor();
                } else {
                    mostrarToast('Sistema de chat no disponible', 'error');
                }
            };



            // Función para cerrar modal de asesor (mantenida para compatibilidad)
            window.cerrarModalAsesor = function () {
                // Ya no se usa, pero se mantiene para evitar errores
            };

            // Inicializar aplicación
            document.addEventListener('DOMContentLoaded', async function () {
                if (verificarAccesoCliente()) {
                    await cargarProductos();

                    // Inicializar sistema de chat
                    const usuario = obtenerUsuarioActual();
                    chatCliente = new ChatCliente(db, usuario);
                    window.chatCliente = chatCliente; // Para acceso global
                }
            });

            // Cerrar modal al hacer clic fuera
            document.getElementById('modalProducto').addEventListener('click', function (e) {
                if (e.target === this) {
                    cerrarModal();
                }
            });

            // Función para ver pedidos
            window.verPedidos = async function () {
                const modalPedidos = document.getElementById('modalPedidos');
                const pedidosBody = document.getElementById('pedidosBody');

                try {
                    const usuario = obtenerUsuarioActual();
                    const pedidosRef = collection(db, "pedidos");
                    const q = query(pedidosRef, where("cliente.email", "==", usuario.email));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        pedidosBody.innerHTML = `
                        <div class="sin-pedidos">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15M9 5V3H15V5M9 5H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <p>No tienes pedidos realizados</p>
                        </div>`;
                        modalPedidos.style.display = 'flex';
                        return;
                    }

                    let html = '';
                    querySnapshot.forEach((doc) => {
                        const pedido = doc.data();
                        const fecha = pedido.fecha.toDate();
                        const fechaFormateada = fecha.toLocaleDateString('es-ES', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        let estadoClase = '';
                        switch (pedido.estado) {
                            case 'pendiente':
                                estadoClase = 'estado-pendiente';
                                break;
                            case 'finalizado':
                                estadoClase = 'estado-finalizado';
                                break;
                            case 'recoger':
                                estadoClase = 'estado-recoger';
                                break;
                        }

                        html += `
                        <div class="pedido-item">
                            <div class="pedido-encabezado">
                                <div class="pedido-numero">${pedido.numeroPedido}</div>
                                <div class="pedido-fecha">${fechaFormateada}</div>
                            </div>
                            <div class="pedido-estado ${estadoClase}">
                                ${pedido.estado.charAt(0).toUpperCase() + pedido.estado.slice(1)}
                            </div>
                            <div class="pedido-productos">
                                ${pedido.productos.map(prod => `
                                    <div class="pedido-producto-item">
                                        <span>${prod.nombre} (${prod.talla}, ${prod.color}) x${prod.cantidad}</span>
                                        <span>S/ ${(prod.precio * prod.cantidad).toFixed(2)}</span>
                                    </div>
                                    ${prod.tipoEnvio === 'con-envio' ? `
                                        <div class="pedido-envio-info">
                                            <small>• Envío: S/ ${(prod.costoEnvio || 0).toFixed(2)}</small>
                                            <small>• IGV: S/ ${(prod.igv || 0).toFixed(2)}</small>
                                        </div>
                                    ` : ''}
                                `).join('')}
                            </div>
                            <div class="pedido-total">
                                ${pedido.subtotal ? `
                                    <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                                        Subtotal: S/ ${pedido.subtotal.toFixed(2)}
                                        ${pedido.costoEnvio > 0 ? `<br>Envío: S/ ${pedido.costoEnvio.toFixed(2)}` : ''}
                                        ${pedido.igv > 0 ? `<br>IGV (18%): S/ ${pedido.igv.toFixed(2)}` : ''}
                                    </div>
                                ` : ''}
                                <strong>Total: S/ ${pedido.total.toFixed(2)}</strong>
                            </div>
                        </div>
                    `;
                    });

                    pedidosBody.innerHTML = html;
                    modalPedidos.style.display = 'flex';

                } catch (error) {
                    console.error('Error al cargar pedidos:', error);
                    mostrarToast('Error al cargar los pedidos', 'error');
                }
            };

            // Cerrar modal de pedidos
            window.cerrarModalPedidos = function () {
                document.getElementById('modalPedidos').style.display = 'none';
            };

            // Cerrar modal de pedidos al hacer clic fuera
            document.getElementById('modalPedidos').addEventListener('click', function (e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });

            // Función para mostrar/ocultar secciones
            window.mostrarSeccion = function (seccion) {
                const seccionProductos = document.getElementById('seccionProductos');
                const seccionChats = document.getElementById('seccionChats');
                const barraCategorias = document.getElementById('barraCategorias');
                const botones = document.querySelectorAll('.boton-nav');

                // Ocultar todas las secciones
                seccionProductos.style.display = 'none';
                seccionChats.style.display = 'none';

                // Remover clase activa de todos los botones
                botones.forEach(btn => btn.classList.remove('activo'));

                // Mostrar la sección seleccionada
                if (seccion === 'chats') {
                    seccionChats.style.display = 'block';
                    barraCategorias.style.display = 'none'; // Ocultar barra de categorías en chats
                    botones[0].classList.add('activo');
                    cargarChats();
                } else if (seccion === 'productos') {
                    seccionProductos.style.display = 'block';
                    barraCategorias.style.display = 'flex'; // Mostrar barra de categorías en productos
                    botones[1].classList.add('activo');
                }
            };

            // Función para cargar chats
            async function cargarChats() {
                const listaChats = document.getElementById('listaChats');

                try {
                    const usuariosRef = collection(db, 'usuarios');
                    const q = query(usuariosRef, where('rol', '==', 'asesor'));
                    const snapshot = await getDocs(q);

                    if (snapshot.empty) {
                        listaChats.innerHTML = `
                            <div class="sin-pedidos">
                                <h3>No hay asesores disponibles</h3>
                                <p>Los asesores aparecerán aquí cuando estén en línea</p>
                            </div>
                        `;
                        return;
                    }

                    let html = '';
                    snapshot.forEach((doc) => {
                        const asesor = doc.data();
                        const iniciales = obtenerIniciales(asesor.nombreUsuario || asesor.email);

                        html += `
                        <div class="chat-card" onclick="iniciarChatConAsesor('${asesor.email}', '${asesor.nombreUsuario || asesor.email}')">
                            <div class="chat-header">
                                <div class="chat-avatar" style="width: 50px; height: 50px; border-radius: 50%; background: #007bff; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px;">${iniciales}</div>
                                <div class="chat-info">
                                    <div class="chat-nombre">${asesor.nombreUsuario || asesor.email}</div>
                                    <div class="chat-estado">
                                        <span class="punto-verde"></span>
                                        Disponible
                                    </div>
                                </div>
                            </div>
                            <div class="chat-ultimo-mensaje">
                                ¡Hola! ¿En qué puedo ayudarte hoy?
                            </div>
                            <div class="chat-acciones">
                                <button class="btn-chat" onclick="event.stopPropagation(); iniciarChatConAsesor('${asesor.email}', '${asesor.nombreUsuario || asesor.email}')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Iniciar Chat
                                </button>
                            </div>
                        </div>
                    `;
                    });

                    listaChats.innerHTML = html;
                } catch (error) {
                    console.error('Error cargando asesores:', error);
                    listaChats.innerHTML = `
                        <div class="sin-pedidos">
                            <h3>Error al cargar asesores</h3>
                            <p>Intenta recargar la página</p>
                        </div>
                    `;
                }
            }

            // Función para obtener iniciales
            function obtenerIniciales(nombre) {
                if (!nombre) return 'A';
                const palabras = nombre.split(' ');
                if (palabras.length >= 2) {
                    return (palabras[0][0] + palabras[1][0]).toUpperCase();
                }
                return nombre[0].toUpperCase();
            }

            // Función para iniciar chat con asesor
            window.iniciarChatConAsesor = function (asesorEmail, asesorNombre) {
                if (chatCliente) {
                    chatCliente.seleccionarAsesor(asesorEmail, asesorNombre);
                } else {
                    mostrarToast('Sistema de chat no disponible', 'error');
                }
            };

            // Función para abrir chat desde botón flotante
            window.abrirChatFlotante = function () {
                if (chatCliente) {
                    chatCliente.mostrarSeleccionAsesor();
                } else {
                    mostrarToast('Sistema de chat no disponible', 'error');
                }
            };

            // Modificar comprarDirecto para pasar talla, color, envío, precio total y dirección
            window.comprarDirecto = function (id, talla, color, tipoEnvio, precioTotal, direccion, costoEnvioCalculado) {
                const producto = productos.find(p => p.id === id);
                if (!producto || producto.stock <= 0) {
                    mostrarToast('Producto sin stock disponible', 'error');
                    return;
                }
                if (!talla) {
                    mostrarToast('Selecciona una talla', 'error');
                    return;
                }
                if (!color) {
                    mostrarToast('Selecciona un color', 'error');
                    return;
                }

                // Calcular costo de envío si no se proporciona
                let costoEnvio = 0;
                if (tipoEnvio === 'envio' && direccion) {
                    if (costoEnvioCalculado) {
                        costoEnvio = costoEnvioCalculado;
                    } else {
                        // Calcular según región
                        const departamento = direccion.departamento;
                        const provincia = direccion.provincia;
                        if (departamento === 'arequipa' && provincia && provincia.toLowerCase().includes('arequipa')) {
                            costoEnvio = Math.floor(Math.random() * (20 - 5 + 1)) + 5; // Entre 5 y 20
                        } else {
                            costoEnvio = Math.floor(Math.random() * (99 - 20 + 1)) + 20; // Entre 20 y 99
                        }
                    }
                }

                // Guardar producto temporalmente para el pago
                window.productoParaPagar = {
                    id: producto.id,
                    nombre: producto.nombre,
                    precio: producto.precio,
                    precioTotal: precioTotal || producto.precio,
                    imagen: producto.imagen,
                    talla: talla,
                    color: color,
                    tipoEnvio: tipoEnvio || 'recojo',
                    costoEnvio: costoEnvio,
                    direccionEnvio: direccion || null,
                    cantidad: 1
                };
                mostrarModalPago();
            };



            // Función para cerrar sesión
            window.cerrarSesion = function () {
                const resultado = cerrarSesionFirebase();
                if (resultado.exito) {
                    mostrarToast('Sesión cerrada exitosamente');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                }
            };

            // 3. Función para mostrar el modal de método de pago
            function mostrarModalPago() {
                const modal = document.getElementById('modalPago');
                const body = document.getElementById('modalPagoBody');
                body.innerHTML = `
                <div style='text-align:center;'>
                    <h3 style='font-size:22px;margin-bottom:18px;'>Método de pago</h3>
                    <div style='display:flex;justify-content:center;gap:15px;margin:20px 0;flex-wrap:wrap;'>
                        <button class='chip-talla metodo-pago-btn' id='btnYape' style='background:#fff;border:2px solid #ddd;color:#7c4dff;display:flex;flex-direction:column;align-items:center;gap:6px;padding:18px 24px;transition:all 0.3s;'>
                            <img src='img2.png' alt='Cuenta Yape' style='width:48px;height:48px;border-radius:12px;box-shadow:0 2px 8px #7c4dff33;'>
                            <span style='font-weight:700;font-size:15px;'>Yape</span>
                        </button>
                        <button class='chip-talla metodo-pago-btn' id='btnBanco' style='background:#fff;border:2px solid #ddd;color:#28a745;display:flex;flex-direction:column;align-items:center;gap:6px;padding:18px 24px;transition:all 0.3s;'>
                            <svg width='48' height='48' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg' style='color:#28a745;'>
                                <path d='M12 1L21 6V8H3V6L12 1Z' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
                                <path d='M21 16V8H3V16H21Z' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
                                <path d='M5 16V20H19V16' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
                                <path d='M9 12H15' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
                            </svg>
                            <span style='font-weight:700;font-size:15px;'>Banco</span>
                        </button>
                    </div>
                    <div id='infoPago'></div>
                </div>
            `;
                modal.style.display = 'flex';

                document.getElementById('btnYape').onclick = function () {
                    // Validar límite de Yape (500 soles)
                    const precios = calcularPrecios();
                    if (precios.total > 500) {
                        mostrarToast('El pago con Yape tiene un límite máximo de S/ 500.00. Para montos superiores, utiliza transferencia bancaria.', 'error');
                        return;
                    }
                    
                    // Resetear estilos
                    document.getElementById('btnYape').style.border = '2px solid #7c4dff';
                    document.getElementById('btnBanco').style.border = '2px solid #ddd';
                    mostrarInfoPago('yape');
                };

                document.getElementById('btnBanco').onclick = function () {
                    // Resetear estilos
                    document.getElementById('btnBanco').style.border = '2px solid #28a745';
                    document.getElementById('btnYape').style.border = '2px solid #ddd';
                    mostrarInfoPago('banco');
                };

                // Asegurar que la X cierre el modal
                document.querySelector('#modalPago .boton-volver').onclick = cerrarModalPago;
            }

            // Función para verificar si el dispositivo soporta cámara
            function verificarSoporteCamara() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.capture = 'environment';

                return 'capture' in input;
            }

            // 4. Mostrar información de pago según método
            function mostrarInfoPago(metodo) {
                const info = document.getElementById('infoPago');

                if (metodo === 'yape') {
                    info.innerHTML = `
                    <div style='margin:30px 0 10px 0;'>
                        <img src='codigo3.png' alt='QR Yape' style='width:160px;height:160px;border-radius:18px;border:3px solid #7c4dff;box-shadow:0 2px 12px #7c4dff22;'>
                    </div>
                    <div style='margin:10px 0 18px 0;font-size:16px;'>
                        <span style='font-weight:600;color:#7c4dff;'>Número:</span> <b style='font-size:18px;'>935 517 141</b>
                    </div>
                    <div style='margin-bottom:10px;'>
                        <label style='display:block;font-weight:600;margin-bottom:6px;'>Sube tu comprobante de pago</label>
                        <input type='file' id='inputComprobante' accept='image/*' style='display:none;'>
                        <input type='file' id='inputComprobanteCamera' accept='image/*' capture='environment' style='display:none;'>
                        <div style='display:flex;gap:10px;flex-wrap:wrap;'>
                            <label for='inputComprobante' id='labelComprobante' style='display:inline-block;padding:10px 18px;background:#7c4dff;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;transition:background .2s;font-size:14px;'><svg style='vertical-align:middle;margin-right:6px;' width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M12 16V4M8 8l4-4 4 4'/><rect x='4' y='16' width='16' height='4' rx='2'/></svg>Galería</label>
                            <button type='button' id='btnCamara' style='display:inline-block;padding:10px 18px;background:#28a745;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:background .2s;font-size:14px;' onmouseover="this.style.background='#1e7e34'" onmouseout="this.style.background='#28a745'"><svg style='vertical-align:middle;margin-right:6px;' width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M23 19C23 20.1046 22.1046 21 21 21H3C1.89543 21 1 20.1046 1 19V8C1 6.89543 1.89543 6 3 6H7L9 3H15L17 6H21C22.1046 6 23 6.89543 23 8V19Z'/><circle cx='12' cy='13' r='4'/></svg>Cámara</button>
                        </div>
                        <span id='nombreComprobante' style='display:block;margin-top:8px;font-size:13px;color:#333;'></span>
                    </div>
                    <button class='modal-btn btn-comprar' style='background:#7c4dff;margin-top:10px;' onclick='confirmarPago("yape")'>He pagado</button>
                `;
                } else if (metodo === 'banco') {
                    info.innerHTML = `
                    <div style='margin:30px 0 20px 0;padding:20px;background:#f8f9fa;border-radius:15px;border:2px solid #28a745;'>
                        <div style='text-align:center;margin-bottom:15px;'>
                            <svg width='60' height='60' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg' style='color:#28a745;'>
                                <path d='M12 1L21 6V8H3V6L12 1Z' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
                                <path d='M21 16V8H3V16H21Z' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
                                <path d='M5 16V20H19V16' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
                                <path d='M9 12H15' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
                            </svg>
                        </div>
                        <div style='margin-bottom:15px;'>
                            <div style='font-weight:600;color:#28a745;margin-bottom:8px;font-size:16px;'>NÚMERO DE CUENTA:</div>
                            <div style='background:#fff;padding:12px;border-radius:8px;border:1px solid #28a745;font-family:monospace;font-size:18px;font-weight:bold;color:#333;text-align:center;letter-spacing:1px;'>25176904921069</div>
                        </div>
                        <div style='margin-bottom:15px;'>
                            <div style='font-weight:600;color:#28a745;margin-bottom:8px;font-size:16px;'>CCI (CUENTA INTERBANCARIA):</div>
                            <div style='background:#fff;padding:12px;border-radius:8px;border:1px solid #28a745;font-family:monospace;font-size:16px;font-weight:bold;color:#333;text-align:center;letter-spacing:1px;'>00225117690492106972</div>
                        </div>
                        <div style='text-align:center;font-size:14px;color:#666;margin-top:15px;'>
                            💡 Realiza tu transferencia y sube el comprobante
                        </div>
                    </div>
                    <div style='margin-bottom:10px;'>
                        <label style='display:block;font-weight:600;margin-bottom:6px;'>Sube tu comprobante de pago</label>
                        <input type='file' id='inputComprobante' accept='image/*' style='display:none;'>
                        <input type='file' id='inputComprobanteCamera' accept='image/*' capture='environment' style='display:none;'>
                        <div style='display:flex;gap:10px;flex-wrap:wrap;'>
                            <label for='inputComprobante' id='labelComprobante' style='display:inline-block;padding:10px 18px;background:#28a745;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;transition:background .2s;font-size:14px;'><svg style='vertical-align:middle;margin-right:6px;' width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M12 16V4M8 8l4-4 4 4'/><rect x='4' y='16' width='16' height='4' rx='2'/></svg>Galería</label>
                            <button type='button' id='btnCamara' style='display:inline-block;padding:10px 18px;background:#007bff;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:background .2s;font-size:14px;' onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'"><svg style='vertical-align:middle;margin-right:6px;' width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M23 19C23 20.1046 22.1046 21 21 21H3C1.89543 21 1 20.1046 1 19V8C1 6.89543 1.89543 6 3 6H7L9 3H15L17 6H21C22.1046 6 23 6.89543 23 8V19Z'/><circle cx='12' cy='13' r='4'/></svg>Cámara</button>
                        </div>
                        <span id='nombreComprobante' style='display:block;margin-top:8px;font-size:13px;color:#333;'></span>
                    </div>
                    <button class='modal-btn btn-comprar' style='background:#28a745;margin-top:10px;' onclick='confirmarPago("banco")'>He pagado</button>
                `;
                }
                // Mostrar nombre del archivo seleccionado y manejar cámara
                setTimeout(() => {
                    const input = document.getElementById('inputComprobante');
                    const inputCamera = document.getElementById('inputComprobanteCamera');
                    const btnCamara = document.getElementById('btnCamara');
                    const nombre = document.getElementById('nombreComprobante');

                    if (input) {
                        input.onchange = function () {
                            nombre.textContent = input.files && input.files.length > 0 ? `📁 ${input.files[0].name}` : '';
                        };
                    }

                    // Función mejorada para manejar la cámara
                    if (btnCamara) {
                        btnCamara.onclick = function () {
                            // Verificar si el dispositivo soporta cámara
                            if (!verificarSoporteCamara()) {
                                mostrarToast('Tu dispositivo no soporta cámara. Usa la galería.', 'info');
                                return;
                            }

                            // Verificar si estamos en HTTPS (requerido para cámara)
                            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                                mostrarToast('La cámara requiere HTTPS. Usa la galería.', 'info');
                                return;
                            }

                            // Intentar usar la cámara
                            if (inputCamera) {
                                inputCamera.click();
                            }
                        };
                    }

                    if (inputCamera) {
                        inputCamera.onchange = function () {
                            if (inputCamera.files && inputCamera.files.length > 0) {
                                nombre.textContent = `📷 ${inputCamera.files[0].name}`;
                            } else {
                                // Si la cámara falla, mostrar mensaje y permitir galería
                                mostrarToast('Cámara no disponible. Usa la galería.', 'info');
                            }
                        };
                    }
                }, 100);
            }

            // 5. Confirmar pago: guardar pedido en Firestore con estado 'proceso' y comprobante
            async function confirmarPago(metodo) {
                const usuario = obtenerUsuarioActual();
                const producto = window.productoParaPagar;
                if (!producto) return;
                const input = document.getElementById('inputComprobante');
                if (!input.files || input.files.length === 0) {
                    mostrarToast('Sube el comprobante de pago', 'error');
                    return;
                }
                // Subir imagen a base64 (simple, para demo; en real, subir a storage y guardar URL)
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = async function (e) {
                    const comprobante = e.target.result;
                    // Guardar pedido en Firestore
                    const pedido = {
                        numeroPedido: generarNumeroPedido(),
                        fecha: new Date(),
                        cliente: { email: usuario.email },
                        productos: [producto],
                        total: producto.precio,
                        estado: 'proceso',
                        metodoPago: metodo,
                        comprobante: comprobante
                    };
                    try {
                        const pedidosRef = collection(db, "pedidos");
                        await addDoc(pedidosRef, pedido);
                        mostrarToast('Pedido registrado. Esperando confirmación del asesor.');
                        cerrarModalPago();
                    } catch (error) {
                        mostrarToast('Error al registrar el pedido', 'error');
                    }
                };
                reader.readAsDataURL(file);
            }

            // 6. Cerrar modal de pago
            function cerrarModalPago() {
                document.getElementById('modalPago').style.display = 'none';
                window.productoParaPagar = null;
            }

            // 7. Botón de historial: ver pedidos del usuario
            window.verHistorial = async function () {
                const modalPedidos = document.getElementById('modalPedidos');
                const pedidosBody = document.getElementById('pedidosBody');
                try {
                    const usuario = obtenerUsuarioActual();
                    const pedidosRef = collection(db, "pedidos");
                    const q = query(pedidosRef, where("cliente.email", "==", usuario.email));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) {
                        pedidosBody.innerHTML = `
                        <div class="sin-pedidos">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15M9 5V3H15V5M9 5H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <p>No tienes pedidos realizados</p>
                        </div>`;
                        modalPedidos.style.display = 'flex';
                        return;
                    }
                    let pedidos = [];
                    querySnapshot.forEach((doc) => {
                        pedidos.push(doc.data());
                    });
                    // Filtrar: solo mostrar pedidos que NO estén en estado 'proceso' (sin comprobante)
                    pedidos = pedidos.filter(p => p.estado !== 'proceso');
                    // Ordenar por fecha descendente (más recientes primero)
                    pedidos.sort((a, b) => b.fecha.toDate() - a.fecha.toDate());
                    let html = '';
                    pedidos.forEach((pedido) => {
                        const fecha = pedido.fecha.toDate();
                        const fechaFormateada = fecha.toLocaleDateString('es-ES', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        let estadoClase = '';
                        switch (pedido.estado) {
                            case 'pendiente':
                                estadoClase = 'estado-pendiente';
                                break;
                            case 'finalizado':
                                estadoClase = 'estado-finalizado';
                                break;
                            case 'recoger':
                                estadoClase = 'estado-recoger';
                                break;
                            case 'proceso':
                                estadoClase = 'estado-pendiente';
                                break;
                            case 'pagado':
                                estadoClase = 'estado-pendiente';
                                break;
                            case 'rechazado':
                                estadoClase = 'estado-rechazado';
                                break;
                        }
                        html += `
                        <div class="pedido-item">
                            <div class="pedido-encabezado">
                                <div class="pedido-numero">${pedido.numeroPedido}</div>
                                <div class="pedido-fecha">${fechaFormateada}</div>
                            </div>
                            <div class="pedido-estado ${estadoClase}">
                                ${pedido.estado.charAt(0).toUpperCase() + pedido.estado.slice(1)}
                            </div>
                            <div class="pedido-productos">
                                ${pedido.productos.map(prod => `
                                    <div class="pedido-producto-item">
                                        <span>${prod.nombre} (${prod.talla}, ${prod.color}) x${prod.cantidad}</span>
                                        <span>S/ ${(prod.precio * prod.cantidad).toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="pedido-total">
                                Total: S/ ${pedido.total.toFixed(2)}
                            </div>
                            ${pedido.comprobante ? `<div style='margin-top:10px;'><b>Comprobante:</b><br><img src='${pedido.comprobante}' style='max-width:120px;border-radius:8px;border:1px solid #eee;'></div>` : ''}
                        </div>
                    `;
                    });
                    pedidosBody.innerHTML = html;
                    modalPedidos.style.display = 'flex';
                } catch (error) {
                    mostrarToast('Error al cargar pedidos', 'error');
                }
            }

            // 1. Subir comprobante a imgbb y guardar URL
            async function subirComprobanteAImgbb(file) {
                const apiKey = '2e40e99a54d9185b904e9667b2658747'; // Usa tu API Key de imgbb
                const formData = new FormData();
                formData.append('image', file);
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.success) {
                    return data.data.url;
                } else {
                    throw new Error('Error al subir comprobante');
                }
            }

            // 2. Hacer confirmarPago global y funcional
            window.confirmarPago = async function (metodo) {
                const usuario = obtenerUsuarioActual();
                const producto = window.productoParaPagar;
                if (!producto) return;

                console.log('Producto para pagar:', producto);

                const input = document.getElementById('inputComprobante');
                const inputCamera = document.getElementById('inputComprobanteCamera');

                let file = null;

                // Verificar si hay archivo en galería o cámara
                if (input && input.files && input.files.length > 0) {
                    file = input.files[0];
                } else if (inputCamera && inputCamera.files && inputCamera.files.length > 0) {
                    file = inputCamera.files[0];
                }

                if (!file) {
                    mostrarToast('Sube el comprobante de pago', 'error');
                    return;
                }
                try {
                    const urlComprobante = await subirComprobanteAImgbb(file);

                    // Calcular totales con envío e IGV
                    const precioBase = producto.precio;
                    const tipoEnvio = producto.tipoEnvio || 'recojo';
                    const costoEnvio = tipoEnvio === 'envio' ? (producto.costoEnvio || 15) : 0;
                    const subtotal = precioBase + costoEnvio;
                    const igv = subtotal * 0.18;
                    const total = subtotal + igv;

                    // Guardar pedido en Firestore
                    const pedido = {
                        numeroPedido: generarNumeroPedido(),
                        fecha: new Date(),
                        cliente: { email: usuario.email },
                        productos: [{
                            ...producto,
                            tipoEnvio: tipoEnvio,
                            costoEnvio: costoEnvio,
                            igv: igv,
                            precioTotal: total
                        }],
                        subtotal: precioBase,
                        costoEnvio: costoEnvio,
                        igv: igv,
                        total: total,
                        estado: 'pagado', // Estado pagado y en revisión
                        metodoPago: metodo,
                        comprobante: urlComprobante,
                        direccionEnvio: producto.direccionEnvio || null, // Agregar dirección de envío
                        revision: true
                    };
                    const pedidosRef = collection(db, "pedidos");
                    await addDoc(pedidosRef, pedido);
                    mostrarToast('Pedido pagado. En revisión del asesor.');
                    cerrarModalPago();
                } catch (error) {
                    console.error('Error en confirmarPago:', error);
                    mostrarToast('Error al subir comprobante o registrar pedido: ' + error.message, 'error');
                }
            }



            // Guardar productos del carrito para el pago
            window.comprarCarrito = function () {
                if (!carrito || carrito.length === 0) {
                    mostrarToast('El carrito está vacío', 'error');
                    return;
                }

                // Validar que todos los productos con envío tengan dirección completa
                const productosConEnvio = carrito.filter(item => item.tipoEnvio === 'envio');
                for (let item of productosConEnvio) {
                    if (!item.direccionEnvio || !item.direccionEnvio.departamento || !item.direccionEnvio.provincia ||
                        !item.direccionEnvio.distrito || !item.direccionEnvio.direccion) {
                        mostrarToast('Algunos productos requieren dirección de envío completa', 'error');
                        return;
                    }
                }

                window.productosParaPagar = carrito.map(item => ({ ...item }));
                mostrarModalPagoCarrito();
            };

            // Modal de método de pago para el carrito
            function mostrarModalPagoCarrito() {
                const modal = document.getElementById('modalPago');
                const body = document.getElementById('modalPagoBody');
                body.innerHTML = `
                <div style='text-align:center;'>
                    <h3 style='font-size:22px;margin-bottom:18px;'>Método de pago</h3>
                    <div style='display:flex;justify-content:center;gap:15px;margin:20px 0;flex-wrap:wrap;'>
                        <button class='chip-talla metodo-pago-btn' id='btnYapeCarrito' style='background:#fff;border:2px solid #ddd;color:#7c4dff;display:flex;flex-direction:column;align-items:center;gap:6px;padding:18px 24px;transition:all 0.3s;'>
                            <img src='img2.png' alt='Cuenta Yape' style='width:48px;height:48px;border-radius:12px;box-shadow:0 2px 8px #7c4dff33;'>
                            <span style='font-weight:700;font-size:15px;'>Yape</span>
                        </button>
                        <button class='chip-talla metodo-pago-btn' id='btnBancoCarrito' style='background:#fff;border:2px solid #ddd;color:#28a745;display:flex;flex-direction:column;align-items:center;gap:6px;padding:18px 24px;transition:all 0.3s;'>
                            <svg width='48' height='48' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg' style='color:#28a745;'>
                                <path d='M12 1L21 6V8H3V6L12 1Z' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
                                <path d='M21 16V8H3V16H21Z' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
                                <path d='M5 16V20H19V16' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
                                <path d='M9 12H15' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
                            </svg>
                            <span style='font-weight:700;font-size:15px;'>Banco</span>
                        </button>
                    </div>
                    <div id='infoPagoCarrito'></div>
                </div>
            `;
                modal.style.display = 'flex';

                document.getElementById('btnYapeCarrito').onclick = function () {
                    // Calcular total del carrito para validar límite de Yape
                    let subtotalGeneral = 0;
                    let envioTotal = 0;
                    let igvTotal = 0;

                    carrito.forEach(item => {
                        const precioBase = parseFloat(item.precio);
                        const costoEnvio = item.tipoEnvio === 'envio' ? 15.00 : 0;
                        const baseImponible = (precioBase + costoEnvio) * item.cantidad;
                        const igvItem = baseImponible * 0.18;

                        subtotalGeneral += precioBase * item.cantidad;
                        envioTotal += costoEnvio * item.cantidad;
                        igvTotal += igvItem;
                    });

                    const totalCarrito = subtotalGeneral + envioTotal + igvTotal;

                    // Validar límite de Yape (500 soles)
                    if (totalCarrito > 500) {
                        mostrarToast('El pago con Yape tiene un límite máximo de S/ 500.00. Para montos superiores, utiliza transferencia bancaria.', 'error');
                        return;
                    }
                    
                    // Resetear estilos
                    document.getElementById('btnYapeCarrito').style.border = '2px solid #7c4dff';
                    document.getElementById('btnBancoCarrito').style.border = '2px solid #ddd';
                    mostrarInfoPagoCarrito('yape');
                };

                document.getElementById('btnBancoCarrito').onclick = function () {
                    // Resetear estilos
                    document.getElementById('btnBancoCarrito').style.border = '2px solid #28a745';
                    document.getElementById('btnYapeCarrito').style.border = '2px solid #ddd';
                    mostrarInfoPagoCarrito('banco');
                };

                // Asegurar que la X cierre el modal
                document.querySelector('#modalPago .boton-volver').onclick = cerrarModalPago;
            }

            function mostrarInfoPagoCarrito(metodo) {
                const info = document.getElementById('infoPagoCarrito');

                if (metodo === 'yape') {
                    info.innerHTML = `
                    <div style='margin:30px 0 10px 0;'>
                        <img src='codigo3.png' alt='QR Yape' style='width:160px;height:160px;border-radius:18px;border:3px solid #7c4dff;box-shadow:0 2px 12px #7c4dff22;'>
                    </div>
                    <div style='margin:10px 0 18px 0;font-size:16px;'>
                        <span style='font-weight:600;color:#7c4dff;'>Número:</span> <b style='font-size:18px;'>935 517 141</b>
                    </div>
                    <div style='margin-bottom:10px;'>
                        <label style='display:block;font-weight:600;margin-bottom:6px;'>Sube tu comprobante de pago</label>
                        <input type='file' id='inputComprobanteCarrito' accept='image/*' style='display:none;'>
                        <input type='file' id='inputComprobanteCameraCarrito' accept='image/*' capture='environment' style='display:none;'>
                        <div style='display:flex;gap:10px;flex-wrap:wrap;'>
                            <label for='inputComprobanteCarrito' id='labelComprobanteCarrito' style='display:inline-block;padding:10px 18px;background:#7c4dff;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;transition:background .2s;font-size:14px;'><svg style='vertical-align:middle;margin-right:6px;' width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M12 16V4M8 8l4-4 4 4'/><rect x='4' y='16' width='16' height='4' rx='2'/></svg>Galería</label>
                            <button type='button' id='btnCamaraCarrito' style='display:inline-block;padding:10px 18px;background:#28a745;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:background .2s;font-size:14px;' onmouseover="this.style.background='#1e7e34'" onmouseout="this.style.background='#28a745'"><svg style='vertical-align:middle;margin-right:6px;' width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M23 19C23 20.1046 22.1046 21 21 21H3C1.89543 21 1 20.1046 1 19V8C1 6.89543 1.89543 6 3 6H7L9 3H15L17 6H21C22.1046 6 23 6.89543 23 8V19Z'/><circle cx='12' cy='13' r='4'/></svg>Cámara</button>
                        </div>
                        <span id='nombreComprobanteCarrito' style='display:block;margin-top:8px;font-size:13px;color:#333;'></span>
                    </div>
                    <button class='modal-btn btn-comprar' style='background:#7c4dff;margin-top:10px;' onclick='confirmarPagoCarrito("yape")'>He pagado</button>
                `;
                } else if (metodo === 'banco') {
                    info.innerHTML = `
                    <div style='margin:30px 0 20px 0;padding:20px;background:#f8f9fa;border-radius:15px;border:2px solid #28a745;'>
                        <div style='text-align:center;margin-bottom:15px;'>
                            <svg width='60' height='60' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg' style='color:#28a745;'>
                                <path d='M12 1L21 6V8H3V6L12 1Z' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
                                <path d='M21 16V8H3V16H21Z' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
                                <path d='M5 16V20H19V16' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
                                <path d='M9 12H15' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
                            </svg>
                        </div>
                        <div style='margin-bottom:15px;'>
                            <div style='font-weight:600;color:#28a745;margin-bottom:8px;font-size:16px;'>NÚMERO DE CUENTA:</div>
                            <div style='background:#fff;padding:12px;border-radius:8px;border:1px solid #28a745;font-family:monospace;font-size:18px;font-weight:bold;color:#333;text-align:center;letter-spacing:1px;'>25176904921069</div>
                        </div>
                        <div style='margin-bottom:15px;'>
                            <div style='font-weight:600;color:#28a745;margin-bottom:8px;font-size:16px;'>CCI (CUENTA INTERBANCARIA):</div>
                            <div style='background:#fff;padding:12px;border-radius:8px;border:1px solid #28a745;font-family:monospace;font-size:16px;font-weight:bold;color:#333;text-align:center;letter-spacing:1px;'>00225117690492106972</div>
                        </div>
                        <div style='text-align:center;font-size:14px;color:#666;margin-top:15px;'>
                            💡 Realiza tu transferencia y sube el comprobante
                        </div>
                    </div>
                    <div style='margin-bottom:10px;'>
                        <label style='display:block;font-weight:600;margin-bottom:6px;'>Sube tu comprobante de pago</label>
                        <input type='file' id='inputComprobanteCarrito' accept='image/*' style='display:none;'>
                        <input type='file' id='inputComprobanteCameraCarrito' accept='image/*' capture='environment' style='display:none;'>
                        <div style='display:flex;gap:10px;flex-wrap:wrap;'>
                            <label for='inputComprobanteCarrito' id='labelComprobanteCarrito' style='display:inline-block;padding:10px 18px;background:#28a745;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;transition:background .2s;font-size:14px;'><svg style='vertical-align:middle;margin-right:6px;' width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M12 16V4M8 8l4-4 4 4'/><rect x='4' y='16' width='16' height='4' rx='2'/></svg>Galería</label>
                            <button type='button' id='btnCamaraCarrito' style='display:inline-block;padding:10px 18px;background:#007bff;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:background .2s;font-size:14px;' onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'"><svg style='vertical-align:middle;margin-right:6px;' width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M23 19C23 20.1046 22.1046 21 21 21H3C1.89543 21 1 20.1046 1 19V8C1 6.89543 1.89543 6 3 6H7L9 3H15L17 6H21C22.1046 6 23 6.89543 23 8V19Z'/><circle cx='12' cy='13' r='4'/></svg>Cámara</button>
                        </div>
                        <span id='nombreComprobanteCarrito' style='display:block;margin-top:8px;font-size:13px;color:#333;'></span>
                    </div>
                    <button class='modal-btn btn-comprar' style='background:#28a745;margin-top:10px;' onclick='confirmarPagoCarrito("banco")'>He pagado</button>
                `;
                }
                setTimeout(() => {
                    const input = document.getElementById('inputComprobanteCarrito');
                    const inputCamera = document.getElementById('inputComprobanteCameraCarrito');
                    const btnCamaraCarrito = document.getElementById('btnCamaraCarrito');
                    const nombre = document.getElementById('nombreComprobanteCarrito');

                    if (input) {
                        input.onchange = function () {
                            nombre.textContent = input.files && input.files.length > 0 ? `📁 ${input.files[0].name}` : '';
                        };
                    }

                    // Función mejorada para manejar la cámara del carrito
                    if (btnCamaraCarrito) {
                        btnCamaraCarrito.onclick = function () {
                            // Verificar si el dispositivo soporta cámara
                            if (!verificarSoporteCamara()) {
                                mostrarToast('Tu dispositivo no soporta cámara. Usa la galería.', 'info');
                                return;
                            }

                            // Verificar si estamos en HTTPS (requerido para cámara)
                            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                                mostrarToast('La cámara requiere HTTPS. Usa la galería.', 'info');
                                return;
                            }

                            // Intentar usar la cámara
                            if (inputCamera) {
                                inputCamera.click();
                            }
                        };
                    }

                    if (inputCamera) {
                        inputCamera.onchange = function () {
                            if (inputCamera.files && inputCamera.files.length > 0) {
                                nombre.textContent = `📷 ${inputCamera.files[0].name}`;
                            } else {
                                // Si la cámara falla, mostrar mensaje y permitir galería
                                mostrarToast('Cámara no disponible. Usa la galería.', 'info');
                            }
                        };
                    }
                }, 100);
            }

            // Confirmar pago del carrito
            window.confirmarPagoCarrito = async function (metodo) {
                const usuario = obtenerUsuarioActual();
                const productos = window.productosParaPagar;
                if (!productos || productos.length === 0) return;

                console.log('Productos del carrito para pagar:', productos);

                const input = document.getElementById('inputComprobanteCarrito');
                const inputCamera = document.getElementById('inputComprobanteCameraCarrito');

                let file = null;

                // Verificar si hay archivo en galería o cámara
                if (input && input.files && input.files.length > 0) {
                    file = input.files[0];
                } else if (inputCamera && inputCamera.files && inputCamera.files.length > 0) {
                    file = inputCamera.files[0];
                }

                if (!file) {
                    mostrarToast('Sube el comprobante de pago', 'error');
                    return;
                }
                try {
                    const urlComprobante = await subirComprobanteAImgbb(file);

                    // Calcular totales con envío e IGV
                    let subtotalGeneral = 0;
                    let envioTotal = 0;
                    let igvTotal = 0;

                    productos.forEach(item => {
                        const precioBase = parseFloat(item.precio);
                        const costoEnvio = item.tipoEnvio === 'envio' ? (item.costoEnvio || 15.00) : 0;
                        const baseImponible = (precioBase + costoEnvio) * item.cantidad;
                        const igvItem = baseImponible * 0.18;

                        subtotalGeneral += precioBase * item.cantidad;
                        envioTotal += costoEnvio * item.cantidad;
                        igvTotal += igvItem;
                    });

                    const totalFinal = subtotalGeneral + envioTotal + igvTotal;

                    // Guardar pedido en Firestore
                    const pedido = {
                        numeroPedido: generarNumeroPedido(),
                        fecha: new Date(),
                        cliente: { email: usuario.email },
                        productos: productos,
                        subtotal: subtotalGeneral,
                        envio: envioTotal,
                        igv: igvTotal,
                        total: totalFinal,
                        estado: 'pagado',
                        metodoPago: metodo,
                        comprobante: urlComprobante,
                        revision: true
                    };
                    const pedidosRef = collection(db, "pedidos");
                    await addDoc(pedidosRef, pedido);
                    mostrarToast('Pedido pagado. En revisión del asesor.');
                    cerrarModalPago();
                    carrito = [];
                    localStorage.setItem('carrito', JSON.stringify(carrito));
                    actualizarContadorCarrito();
                } catch (error) {
                    mostrarToast('Error al subir comprobante o registrar pedido', 'error');
                }
            }

            // Variable global para categoría seleccionada
            let categoriaSeleccionada = '';
            // Filtrar por categoría
            window.filtrarPorCategoria = function (categoria) {
                categoriaSeleccionada = categoria;
                // Marcar botón activo
                document.querySelectorAll('.btn-categoria').forEach(btn => {
                    btn.classList.remove('activa');
                    if (btn.textContent.trim().toLowerCase() === (categoria ? categoria : 'todos')) {
                        btn.classList.add('activa');
                    }
                });
                mostrarProductos();
            };

            // Función para abrir productos.html en ventana emergente
            window.abrirProductosPrueba = function() {
                const ventanaProductos = window.open(
                    'productos.html',
                    'ProductosPrueba',
                    'width=1200,height=800,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no,status=no'
                );
                
                if (ventanaProductos) {
                    ventanaProductos.focus();
                } else {
                    // Si el popup fue bloqueado, mostrar mensaje
                    mostrarToast('Por favor permite ventanas emergentes para ver la lista de productos', 'error');
                }
            };
        </script>

        <!-- Script del Chat con IA -->
        <script src="chat-ia.js"></script>
</body>

</html>